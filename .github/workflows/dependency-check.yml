name: Dependency Security Check

on:
  pull_request:
    branches:
      - main
      - master
  issue_comment:
    types: [created, edited]
  workflow_dispatch:

# åªåœ¨ PR ç›¸å…³çš„äº‹ä»¶æ—¶è¿è¡Œ
jobs:
  check-if-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      is-pr: ${{ steps.check.outputs.is-pr }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      should-trigger: ${{ steps.check.outputs.should-trigger }}
    steps:
      - name: Check if this is a PR and should trigger
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('is-pr', 'true');
              core.setOutput('pr-number', context.issue.number);
              core.setOutput('should-trigger', 'true');
            } else if (context.eventName === 'issue_comment') {
              // æ£€æŸ¥æ˜¯å¦æ˜¯ PR çš„è¯„è®º
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              if (issue.pull_request) {
                // è·å– PR ä¿¡æ¯ä»¥è·å– head SHA
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number
                });
                
                // æ£€æŸ¥è¯„è®ºä¸­æ˜¯å¦åŒ…å« skip å…³é”®å­—
                const skipKeywords = [
                  '[skip dependency check]',
                  '[skip-dependency-check]',
                  '[skip dependency-check]',
                  '[skip-dependency check]'
                ];
                
                const commentBody = context.payload.comment.body.toLowerCase();
                const hasSkipKeyword = skipKeywords.some(keyword => 
                  commentBody.includes(keyword.toLowerCase())
                );
                
                if (hasSkipKeyword) {
                  core.setOutput('is-pr', 'true');
                  core.setOutput('pr-number', context.issue.number);
                  core.setOutput('should-trigger', 'true');
                  core.setOutput('pr-head-sha', pr.head.sha);
                  console.log('âœ… æ£€æµ‹åˆ°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è§¦å‘ workflow');
                  console.log(`PR head SHA: ${pr.head.sha}`);
                } else {
                  core.setOutput('is-pr', 'false');
                  core.setOutput('should-trigger', 'false');
                  console.log('â„¹ï¸ è¯„è®ºä¸­æœªåŒ…å«è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œè·³è¿‡ workflow');
                }
              } else {
                core.setOutput('is-pr', 'false');
                core.setOutput('should-trigger', 'false');
              }
            } else {
              core.setOutput('is-pr', 'true'); // workflow_dispatch ä¹Ÿå…è®¸è¿è¡Œ
              core.setOutput('pr-number', '');
              core.setOutput('should-trigger', 'true');
            }

  dependency-check:
    needs: check-if-pr
    if: needs.check-if-pr.outputs.should-trigger == 'true'
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read
      issues: write
      statuses: write

    steps:
      - name: Get PR head SHA for issue_comment event
        if: github.event_name == 'issue_comment'
        id: get-pr-sha
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('pr-head-sha', pr.head.sha);
            console.log(`PR head SHA: ${pr.head.sha}`);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ PR è¯„è®º
          ref: ${{ github.event_name == 'issue_comment' && steps.get-pr-sha.outputs.pr-head-sha || github.event.pull_request.head.sha || github.sha }}

      - name: Check if skip file exists
        id: check-skip-file
        run: |
          if [ -f .github/dependency-check-skip ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°è·³è¿‡æ£€æŸ¥æ–‡ä»¶ (.github/dependency-check-skip)ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR comments for skip keyword
        if: steps.check-skip-file.outputs.skip == 'false'
        id: check-skip-comment
        uses: actions/github-script@v7
        with:
          script: |
            const skipKeywords = [
              '[skip dependency check]',
              '[skip-dependency-check]',
              '[skip dependency-check]',
              '[skip-dependency check]'
            ];
            
            let hasSkipKeyword = false;
            
            if (context.eventName === 'issue_comment') {
              // å¯¹äº issue_comment äº‹ä»¶ï¼šåªæ£€æŸ¥è§¦å‘äº‹ä»¶çš„è¯„è®º
              // è¿™æ ·æ¯æ¬¡è¯„è®ºåªä¼šå½±å“å½“å‰è¿™æ¬¡è§¦å‘ï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºä¼šé‡æ–°æ£€æŸ¥
              const triggerComment = context.payload.comment.body.toLowerCase();
              hasSkipKeyword = skipKeywords.some(keyword => triggerComment.includes(keyword.toLowerCase()));
              
              if (hasSkipKeyword) {
                console.log('âœ… åœ¨è§¦å‘è¯„è®ºä¸­å‘ç°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è·³è¿‡æœ¬æ¬¡ä¾èµ–å®‰å…¨æ£€æŸ¥');
                console.log('â„¹ï¸ æ³¨æ„ï¼šæ­¤è·³è¿‡ä»…å¯¹æœ¬æ¬¡è§¦å‘æœ‰æ•ˆï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºå°†é‡æ–°æ‰§è¡Œæ£€æŸ¥');
              }
            } else if (context.eventName === 'pull_request') {
              // å¯¹äº pull_request äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              // å› ä¸ºè¿™æ˜¯æ–°çš„ commit è§¦å‘çš„ï¼Œåº”è¯¥æ­£å¸¸æ‰§è¡Œæ£€æŸ¥
              // å¦‚æœç”¨æˆ·æƒ³è·³è¿‡ï¼Œåº”è¯¥åœ¨ commit åæ·»åŠ è¯„è®ºæ¥è§¦å‘
              hasSkipKeyword = false;
              console.log('â„¹ï¸ pull_request äº‹ä»¶ï¼šæ­£å¸¸æ‰§è¡Œæ£€æŸ¥ï¼Œä¸æ£€æŸ¥ skip è¯„è®º');
            } else {
              // workflow_dispatch ç­‰å…¶ä»–äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              hasSkipKeyword = false;
            }
            
            if (hasSkipKeyword) {
              core.setOutput('skip', 'true');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Comment PR when skipped
        if: (steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true') && github.event_name != 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let prNumber = context.issue.number;
            
            let skipReason = '';
            if (fs.existsSync('.github/dependency-check-skip')) {
              skipReason = 'é…ç½®æ–‡ä»¶ (`.github/dependency-check-skip`)';
            } else {
              skipReason = 'PR è¯„è®ºä¸­çš„è·³è¿‡å…³é”®å­—';
            }
            
            const comment = `## â­ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡\n\n` +
              `ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡ ${skipReason}ï¼‰ã€‚\n\n` +
              `âœ… çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶ã€‚\n\n` +
              `---\n\n` +
              `> ğŸ’¡ æç¤ºï¼šå¦‚æœåç»­æœ‰æ–°çš„ commitï¼Œå°†é‡æ–°æ‰§è¡Œä¾èµ–å®‰å…¨æ£€æŸ¥ã€‚`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip check if requested
        if: steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true'
        run: |
          echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆå·²é€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚è·³è¿‡ï¼‰"
          echo "âœ… æ£€æŸ¥å·²è·³è¿‡ï¼ŒçŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸ"
          exit 0

      - name: Set up JDK 17
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Check for dependency updates
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: check-updates
        run: |
          echo "æ£€æŸ¥ä¾èµ–æ›´æ–°..."
          mkdir -p target
          mvn versions:display-dependency-updates -DoutputFile=target/dependency-updates.txt || true
          
          if [ -f target/dependency-updates.txt ] && [ -s target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
            
            # è§£æå¹¶ç”Ÿæˆæ›´æœ‰ç”¨çš„ Markdown æŠ¥å‘Š
            python3 << 'PYTHON_SCRIPT'
import re
import sys

def parse_version(version_str):
    """è§£æç‰ˆæœ¬å·ï¼Œè¿”å› (major, minor, patch)"""
    if not version_str:
        return (0, 0, 0)
    # ç§»é™¤éæ•°å­—å­—ç¬¦ï¼Œåªä¿ç•™ç‰ˆæœ¬å·éƒ¨åˆ†
    version_str = re.sub(r'[^0-9.]', '', version_str.split()[0] if ' ' in version_str else version_str)
    parts = version_str.split('.')
    major = int(parts[0]) if len(parts) > 0 and parts[0].isdigit() else 0
    minor = int(parts[1]) if len(parts) > 1 and parts[1].isdigit() else 0
    patch = int(parts[2]) if len(parts) > 2 and parts[2].isdigit() else 0
    return (major, minor, patch)

def classify_update(current, latest):
    """åˆ†ç±»æ›´æ–°ç±»å‹"""
    cv = parse_version(current)
    lv = parse_version(latest)
    
    if lv[0] > cv[0]:
        return 'Major'
    elif lv[1] > cv[1]:
        return 'Minor'
    elif lv[2] > cv[2]:
        return 'Patch'
    return 'Unknown'

try:
    with open('target/dependency-updates.txt', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # æå–æ›´æ–°ä¿¡æ¯ï¼šæ ¼å¼é€šå¸¸æ˜¯ groupId:artifactId:type:currentVersion -> latestVersion
    pattern = r'\[INFO\]\s+([^:]+:[^:]+:[^:]+):([^\s->]+)\s+->\s+([^\s]+)'
    matches = re.findall(pattern, content)
    
    if not matches:
        print("# ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ")
        print("")
        print("## âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬")
        print("")
        print("æ²¡æœ‰å‘ç°éœ€è¦æ›´æ–°çš„ä¾èµ–ã€‚")
    else:
        updates = []
        for match in matches:
            dep_coord = match[0]  # groupId:artifactId:type
            current = match[1]
            latest = match[2]
            update_type = classify_update(current, latest)
            
            # æå– groupId:artifactId
            dep_parts = dep_coord.split(':')
            dep_name = f"{dep_parts[0]}:{dep_parts[1]}" if len(dep_parts) >= 2 else dep_coord
            
            updates.append({
                'name': dep_name,
                'current': current,
                'latest': latest,
                'type': update_type
            })
        
        # æŒ‰ç±»å‹åˆ†ç±»
        major_updates = [u for u in updates if u['type'] == 'Major']
        minor_updates = [u for u in updates if u['type'] == 'Minor']
        patch_updates = [u for u in updates if u['type'] == 'Patch']
        
        print("# ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ")
        print("")
        print(f"> ğŸ’¡ æç¤ºï¼šå‘ç° **{len(updates)}** ä¸ªä¾èµ–æœ‰å¯ç”¨æ›´æ–°ï¼Œå»ºè®®ä¼˜å…ˆæ›´æ–°æœ‰å®‰å…¨ä¿®å¤çš„ç‰ˆæœ¬")
        print("")
        print(f"## ğŸ“¦ æ›´æ–°æ‘˜è¦")
        print("")
        print(f"- ğŸ”´ **ä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆMajorï¼‰**: {len(major_updates)} ä¸ª")
        print(f"- ğŸŸ¡ **æ¬¡è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆMinorï¼‰**: {len(minor_updates)} ä¸ª")
        print(f"- ğŸŸ¢ **è¡¥ä¸ç‰ˆæœ¬æ›´æ–°ï¼ˆPatchï¼‰**: {len(patch_updates)} ä¸ª")
        print("")
        
        # ä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰ 30 ä¸ªï¼‰
        if major_updates:
            print("### ğŸ”´ ä¸»è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆMajorï¼‰- ä¼˜å…ˆå¤„ç†")
            print("")
            print("| ä¾èµ– | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ |")
            print("|------|----------|----------|")
            for update in major_updates[:30]:
                print(f"| `{update['name']}` | `{update['current']}` | `{update['latest']}` |")
            if len(major_updates) > 30:
                print(f"| ... è¿˜æœ‰ {len(major_updates) - 30} ä¸ªä¸»è¦ç‰ˆæœ¬æ›´æ–° | | |")
            print("")
        
        # æ¬¡è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰ 20 ä¸ªï¼‰
        if minor_updates:
            print("### ğŸŸ¡ æ¬¡è¦ç‰ˆæœ¬æ›´æ–°ï¼ˆMinorï¼‰")
            print("")
            print("| ä¾èµ– | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ |")
            print("|------|----------|----------|")
            for update in minor_updates[:20]:
                print(f"| `{update['name']}` | `{update['current']}` | `{update['latest']}` |")
            if len(minor_updates) > 20:
                print(f"| ... è¿˜æœ‰ {len(minor_updates) - 20} ä¸ªæ¬¡è¦ç‰ˆæœ¬æ›´æ–° | | |")
            print("")
        
        # è¡¥ä¸ç‰ˆæœ¬æ›´æ–°ï¼ˆæœ€å¤šæ˜¾ç¤ºå‰ 10 ä¸ªï¼‰
        if patch_updates:
            print("### ğŸŸ¢ è¡¥ä¸ç‰ˆæœ¬æ›´æ–°ï¼ˆPatchï¼‰- å»ºè®®åŠæ—¶æ›´æ–°")
            print("")
            print("| ä¾èµ– | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ |")
            print("|------|----------|----------|")
            for update in patch_updates[:10]:
                print(f"| `{update['name']}` | `{update['current']}` | `{update['latest']}` |")
            if len(patch_updates) > 10:
                print(f"| ... è¿˜æœ‰ {len(patch_updates) - 10} ä¸ªè¡¥ä¸ç‰ˆæœ¬æ›´æ–° | | |")
            print("")
        
        # å®Œæ•´åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
        print("---")
        print("")
        print("### ğŸ“‹ å®Œæ•´æ›´æ–°åˆ—è¡¨")
        print("")
        print("<details>")
        print(f"<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹æ‰€æœ‰ {len(updates)} ä¸ªä¾èµ–æ›´æ–°è¯¦æƒ…</summary>")
        print("")
        print("```")
        with open('target/dependency-updates.txt', 'r', encoding='utf-8') as f:
            print(f.read())
        print("```")
        print("")
        print("</details>")
        print("")
        print("### ğŸ’¡ æ›´æ–°å»ºè®®")
        print("")
        print("1. **ä¼˜å…ˆæ›´æ–° Major ç‰ˆæœ¬**ï¼šå¯èƒ½åŒ…å«é‡å¤§åŠŸèƒ½æ”¹è¿›å’Œå®‰å…¨ä¿®å¤")
        print("2. **å®šæœŸæ›´æ–° Minor ç‰ˆæœ¬**ï¼šé€šå¸¸åŒ…å«æ–°åŠŸèƒ½å’Œå‘åå…¼å®¹çš„æ”¹è¿›")
        print("3. **åŠæ—¶æ›´æ–° Patch ç‰ˆæœ¬**ï¼šé€šå¸¸åŒ…å«é‡è¦çš„ bug ä¿®å¤å’Œå®‰å…¨è¡¥ä¸")
        print("4. **ä½¿ç”¨ Maven å‘½ä»¤æ›´æ–°**ï¼š")
        print("   ```bash")
        print("   # æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œå»ºè®®å…ˆæµ‹è¯•ï¼‰")
        print("   mvn versions:use-latest-versions")
        print("   ")
        print("   # æ›´æ–°ç‰¹å®šä¾èµ–")
        print("   mvn versions:set -DnewVersion=æ–°ç‰ˆæœ¬å· -DgroupId=ç»„ID -DartifactId=æ„ä»¶ID")
        print("   ```")

except Exception as e:
    print(f"# ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ")
    print("")
    print(f"âš ï¸ è§£æä¾èµ–æ›´æ–°ä¿¡æ¯æ—¶å‡ºé”™: {e}")
    print("")
    print("### åŸå§‹è¾“å‡º")
    print("")
    print("```")
    try:
        with open('target/dependency-updates.txt', 'r', encoding='utf-8') as f:
            print(f.read())
    except:
        print("æ— æ³•è¯»å–æ–‡ä»¶")
    print("```")
PYTHON_SCRIPT
            ) > target/dependency-updates.md
            
            echo "âœ… å·²ç”Ÿæˆä¼˜åŒ–çš„ä¾èµ–æ›´æ–°æŠ¥å‘Šï¼štarget/dependency-updates.md"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¾èµ–æ›´æ–°ä¿¡æ¯æˆ–æ–‡ä»¶ä¸ºç©º"
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: dependency-check
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          mvn verify -DskipTests

      - name: List generated files
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          echo "=== dependency-check-reports ç›®å½• ==="
          ls -lah target/dependency-check-reports/ || echo "ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== target ç›®å½• ==="
          ls -lah target/ | grep -E "(dependency|update)" || echo "æœªæ‰¾åˆ°ç›¸å…³æ–‡ä»¶"

      - name: Upload dependency check reports
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/
            target/dependency-updates.txt
            target/dependency-updates.md
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with detailed summary
        if: failure() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è·å– PR ç¼–å·
            let prNumber = context.issue.number;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            }
            
            // è·å– Actions è¿è¡Œé“¾æ¥å’Œ Artifacts é“¾æ¥
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactsUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            // è·å– Artifacts ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆä¸‹è½½é“¾æ¥ï¼‰
            // æ³¨æ„ï¼šGitHub Artifacts éœ€è¦é€šè¿‡ Actions é¡µé¢ä¸‹è½½ï¼Œæ— æ³•ç›´æ¥ç”Ÿæˆä¸‹è½½é“¾æ¥
            // ä½†å¯ä»¥æä¾› Artifacts é¡µé¢çš„é“¾æ¥
            
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= 7.0ï¼‰ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n\n';
            comment += '- **çŠ¶æ€**: âŒ å¤±è´¥\n';
            comment += `- **Actions è¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${runUrl})\n`;
            comment += `- **æŠ¥å‘Šä¸‹è½½**: [ä¸‹è½½ Artifactsï¼ˆåŒ…å« HTML/JSON/TXT æŠ¥å‘Šï¼‰](${artifactsUrl})\n`;
            comment += '  - åœ¨ Actions è¿è¡Œé¡µé¢åº•éƒ¨æ‰¾åˆ° "Artifacts" éƒ¨åˆ†\n';
            comment += '  - ç‚¹å‡» "dependency-check-reports" ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š\n';
            comment += '  - HTML æŠ¥å‘Šï¼š`dependency-check-report.html`ï¼ˆæ¨èï¼Œå¯åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼‰\n';
            comment += '  - JSON æŠ¥å‘Šï¼š`dependency-check-report.json`\n';
            comment += '  - ä¾èµ–æ›´æ–°ï¼š`dependency-updates.txt` å’Œ `dependency-updates.md`\n\n';
            comment += '---\n\n';
            
            // è¯»å–å¹¶è§£æ JSON æŠ¥å‘Šï¼ˆä»…ç”¨äºæå–æ¼æ´ä¿¡æ¯ï¼Œä¸æ˜¾ç¤º JSONï¼‰
            let vulnerabilities = [];
            let txtReportContent = '';
            try {
              const reportPath = 'target/dependency-check-reports/dependency-check-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                if (report.dependencies) {
                  vulnerabilities = report.dependencies
                    .filter(dep => dep.vulnerabilities && dep.vulnerabilities.length > 0)
                    .flatMap(dep => {
                      const depName = dep.packages && dep.packages.length > 0 
                        ? dep.packages[0].name || 'Unknown'
                        : 'Unknown';
                      return dep.vulnerabilities.map(vuln => ({
                        name: depName,
                        cve: vuln.name,
                        severity: vuln.severity || 'Unknown',
                        cvssv3: vuln.cvssv3?.baseScore || vuln.cvssv3?.baseSeverity || vuln.cvssv2?.score || 'N/A',
                        description: vuln.description || '',
                        references: vuln.references || []
                      }));
                    })
                    .sort((a, b) => {
                      const scoreA = parseFloat(a.cvssv3) || 0;
                      const scoreB = parseFloat(b.cvssv3) || 0;
                      return scoreB - scoreA;
                    });
                }
              }
              
              // è¯»å– HTML æŠ¥å‘Šå¹¶è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
              const htmlReportPath = 'target/dependency-check-reports/dependency-check-report.html';
              if (fs.existsSync(htmlReportPath)) {
                const htmlContent = fs.readFileSync(htmlReportPath, 'utf8');
                // ç®€å•æå–æ–‡æœ¬å†…å®¹ï¼ˆç§»é™¤ HTML æ ‡ç­¾ï¼‰
                txtReportContent = htmlContent
                  .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                  .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                  .replace(/<[^>]+>/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();
              }
            } catch (error) {
              console.log('æ— æ³•è§£ææŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            // æ·»åŠ æ¼æ´åˆ—è¡¨
            if (vulnerabilities.length > 0) {
              comment += '### ğŸš¨ å‘ç°çš„é«˜é£é™©æ¼æ´\n\n';
              comment += `å…±å‘ç° **${vulnerabilities.length}** ä¸ªé«˜é£é™©æ¼æ´ï¼š\n\n`;
              comment += '| ä¾èµ– | CVE | ä¸¥é‡ç¨‹åº¦ | CVSS åˆ†æ•° |\n';
              comment += '|------|-----|----------|----------|\n';
              
              const displayCount = Math.min(vulnerabilities.length, 20);
              vulnerabilities.slice(0, displayCount).forEach(v => {
                const name = (v.name || 'Unknown').replace(/\|/g, '\\|').substring(0, 50);
                const cve = (v.cve || 'Unknown').replace(/\|/g, '\\|');
                const severity = (v.severity || 'Unknown').replace(/\|/g, '\\|');
                comment += `| ${name} | ${cve} | ${severity} | ${v.cvssv3} |\n`;
              });
              
              if (vulnerabilities.length > displayCount) {
                comment += `\n*è¿˜æœ‰ ${vulnerabilities.length - displayCount} ä¸ªæ¼æ´ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š*\n\n`;
              }
              
              comment += '\n---\n\n';
            }
            
            // æ·»åŠ ä¿®å¤å»ºè®®
            comment += '### ğŸ’¡ ä¿®å¤å»ºè®®\n\n';
            comment += '1. **æ›´æ–°ä¾èµ–ç‰ˆæœ¬**ï¼šä¼˜å…ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n';
            comment += '2. **æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**ï¼šä¸‹è½½ HTML æŠ¥å‘ŠæŸ¥çœ‹å®Œæ•´ä¿¡æ¯\n';
            comment += '3. **æ·»åŠ æŠ‘åˆ¶è§„åˆ™**ï¼šå¦‚æœæ¼æ´å¯ä»¥æ¥å—ï¼Œåœ¨ `dependency-check-suppression.xml` ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™\n';
            comment += '4. **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæœ¬æ¬¡ PR ä¸æ¶‰åŠä¾èµ–å˜æ›´ï¼Œå¯ä»¥åœ¨ PR ä¸­æ·»åŠ è¯„è®º `[skip-dependency-check]` è·³è¿‡æ£€æŸ¥\n';
            comment += '5. **é‡æ–°æäº¤**ï¼šä¿®å¤åé‡æ–°æäº¤ PR\n\n';
            comment += '---\n\n';
            
            // æ·»åŠ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆTXT æ ¼å¼ï¼Œå¯æŠ˜å ï¼‰
            if (txtReportContent) {
              comment += '### ğŸ“ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰\n\n';
              comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹åŸå§‹æ–‡æœ¬æŠ¥å‘Šï¼ˆå‰ 2000 å­—ç¬¦ï¼‰</summary>\n\n';
              comment += '```\n';
              
              // é™åˆ¶è¾“å‡ºé•¿åº¦
              const maxChars = 2000;
              const displayContent = txtReportContent.length > maxChars 
                ? txtReportContent.substring(0, maxChars) + `\n\n... (è¿˜æœ‰ ${txtReportContent.length - maxChars} ä¸ªå­—ç¬¦ï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹)`
                : txtReportContent;
              
              comment += displayContent;
              comment += '\n```\n';
              comment += '</details>\n\n';
            }
            
            // æ·»åŠ ä¾èµ–æ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼Œä¹Ÿæ”¾åˆ°å¯æŠ˜å åŒºåŸŸï¼‰
            try {
              const updatesPath = 'target/dependency-updates.txt';
              if (fs.existsSync(updatesPath)) {
                const updatesContent = fs.readFileSync(updatesPath, 'utf8');
                if (updatesContent.trim()) {
                  comment += '---\n\n';
                  comment += '### ğŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ\n\n';
                  comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹ä¾èµ–æ›´æ–°è¯¦æƒ…</summary>\n\n';
                  
                  // è¯»å– Markdown æ ¼å¼çš„æ›´æ–°æŠ¥å‘Š
                  const updatesMdPath = 'target/dependency-updates.md';
                  if (fs.existsSync(updatesMdPath)) {
                    const mdContent = fs.readFileSync(updatesMdPath, 'utf8');
                    comment += mdContent;
                  } else {
                    comment += '```\n';
                    comment += updatesContent.substring(0, 2000);
                    if (updatesContent.length > 2000) {
                      comment += `\n\n... (è¿˜æœ‰ ${updatesContent.length - 2000} ä¸ªå­—ç¬¦)`;
                    }
                    comment += '\n```\n';
                  }
                  
                  comment += '</details>\n';
                }
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æ–‡ä»¶:', error.message);
            }
            
            // å‘é€è¯„è®º
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Report status check result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // æ£€æŸ¥æ˜¯å¦è·³è¿‡äº†æ£€æŸ¥
            const skipFile = process.env.SKIP_FILE === 'true';
            const skipComment = process.env.SKIP_COMMENT === 'true';
            const skipped = skipFile || skipComment;
            
            // è·å– PR ç¼–å·å’Œ SHA
            let prNumber = context.issue.number;
            let sha = context.sha;
            
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
              // è·å– PR çš„ head SHA
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              sha = pr.head.sha;
            } else if (context.eventName === 'pull_request') {
              sha = context.payload.pull_request.head.sha;
            }
            
            if (skipped) {
              // è·³è¿‡æ£€æŸ¥æ—¶ï¼ŒæŠ¥å‘ŠæˆåŠŸçŠ¶æ€
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                state: 'success',
                context: 'Dependency Security Check / OWASP Dependency Check',
                description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰',
                target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
              console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰');
            } else {
              // æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
              const checkOutcome = process.env.CHECK_OUTCOME || 'unknown';
              
              if (checkOutcome === 'failure') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'failure',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âŒ çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºå¤±è´¥');
              } else if (checkOutcome === 'success') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'success',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸ');
              }
            }

      - name: Check scan result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        run: |
          # å¦‚æœè·³è¿‡äº†æ£€æŸ¥ï¼Œç›´æ¥æˆåŠŸé€€å‡º
          if [ "$SKIP_FILE" == "true" ] || [ "$SKIP_COMMENT" == "true" ]; then
            echo "âœ… å·²è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰"
            echo "çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶"
            exit 0
          fi
          
          # æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
          if [ "$CHECK_OUTCOME" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤ï¼Œæˆ–åœ¨ PR ä¸­æ·»åŠ è¯„è®º [skip-dependency-check] è·³è¿‡æ£€æŸ¥"
            exit 1
          elif [ "$CHECK_OUTCOME" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            exit 0
          elif [ "$CHECK_OUTCOME" == "skipped" ]; then
            echo "âš ï¸ ä¾èµ–æ£€æŸ¥æ­¥éª¤è¢«è·³è¿‡"
            exit 0
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€æœªçŸ¥: $CHECK_OUTCOME"
            exit 1
          fi
