name: Dependency Review

on:
  pull_request_target:
    # 使用 pull_request_target 以便具备写权限向 PR 评论（含来自 fork 的 PR）
    types: [opened, synchronize, reopened, edited, ready_for_review]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Detect event and parse context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            const result = {
              event: eventName,
              isPR: false,
              prNumber: '',
              headRef: '',
              baseRef: '',
              headSha: '',
              baseSha: '',
              commentBody: ''
            };
            if (eventName === 'pull_request' || eventName === 'pull_request_target') {
              result.isPR = true;
              result.prNumber = context.payload.pull_request.number;
              result.headRef = context.payload.pull_request.head.ref;
              result.baseRef = context.payload.pull_request.base.ref;
              result.headSha = context.payload.pull_request.head.sha;
              result.baseSha = context.payload.pull_request.base.sha;
            } else if (eventName === 'issue_comment') {
              const isPR = !!context.payload.issue.pull_request;
              result.isPR = isPR;
              result.prNumber = context.payload.issue.number;
              result.commentBody = context.payload.comment.body || '';
              if (isPR) {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: result.prNumber
                });
                result.headRef = pr.data.head.ref;
                result.baseRef = pr.data.base.ref;
                result.headSha = pr.data.head.sha;
                result.baseSha = pr.data.base.sha;
              }
            }
            core.setOutput('event', result.event);
            core.setOutput('isPR', String(result.isPR));
            core.setOutput('prNumber', String(result.prNumber));
            core.setOutput('headRef', result.headRef);
            core.setOutput('baseRef', result.baseRef);
            core.setOutput('headSha', result.headSha);
            core.setOutput('baseSha', result.baseSha);
            core.setOutput('commentBody', result.commentBody);

      - name: No-op when issue_comment is not on a PR
        if: github.event_name == 'issue_comment' && steps.ctx.outputs.isPR != 'true'
        run: echo "Issue comment is not on a PR. Nothing to do." && exit 0

      - name: Check comment keywords (trigger or skip)
        id: kw
        if: github.event_name == 'issue_comment'
        shell: bash
        env:
          COMMENT_BODY: ${{ steps.ctx.outputs.commentBody }}
        run: |
          body_lc="$(printf "%s" "$COMMENT_BODY" | tr '[:upper:]' '[:lower:]')"
          # 仅支持“跳过检查”的关键字（保持与之前设计一致的四种写法）
          # [skip dependency check] | [skip-dependency-check] | [skip dependency-check] | [skip-dependency check]
          if echo "$body_lc" | grep -qE '\[skip dependency check\]|\[skip-dependency-check\]|\[skip dependency-check\]|\[skip-dependency check\]'; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip by keyword (commented)
        if: github.event_name == 'issue_comment' && steps.kw.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body: "✅ 已根据评论关键字跳过依赖变更审查（Dependency Review）。"
            });
            core.notice('Skip keyword detected. Dependency review skipped.');
          result-encoding: string

      - name: Early exit after skip
        if: github.event_name == 'issue_comment' && steps.kw.outputs.skip == 'true'
        run: echo "Skipped by keyword." && exit 0

      - name: No-op for non-skip comments
        if: github.event_name == 'issue_comment' && steps.kw.outputs.skip != 'true'
        run: echo "Comment does not contain skip keywords. Nothing to do." && exit 0

      - name: Dependency Review
        if: startsWith(github.event_name, 'pull_request')
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: false

      - name: Post filtered summary comment
        if: startsWith(github.event_name, 'pull_request')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '.github/ignore-deps.txt';
            let ignored = [];
            if (fs.existsSync(path)) {
              ignored = fs.readFileSync(path, 'utf8')
                .split('\n')
                .map(s => s.trim())
                .filter(s => s && !s.startsWith('#'));
            }
            const header = 'Dependency Review（过滤后摘要）';
            const bodyLines = [];
            if (ignored.length) {
              bodyLines.push('已忽略的依赖（按规则文件）：');
              for (const item of ignored) bodyLines.push(`- ${item}`);
              bodyLines.push('');
            } else {
              bodyLines.push('无忽略规则。');
              bodyLines.push('');
            }
            bodyLines.push('完整明细请查看本次 Actions 运行页面的 Dependency Review 日志。');
            const body = `### ${header}\n\n` + bodyLines.join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body
            });


