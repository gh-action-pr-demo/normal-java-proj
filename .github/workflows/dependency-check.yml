name: Dependency Security Check

on:
  pull_request:
    branches:
      - main
      - master
  issue_comment:
    types: [created]
  workflow_dispatch:

# åªåœ¨ PR ç›¸å…³çš„äº‹ä»¶æ—¶è¿è¡Œ
jobs:
  check-if-pr:
    runs-on: ubuntu-latest
    outputs:
      is-pr: ${{ steps.check.outputs.is-pr }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    steps:
      - name: Check if this is a PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('is-pr', 'true');
              core.setOutput('pr-number', context.issue.number);
            } else if (context.eventName === 'issue_comment') {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              if (issue.pull_request) {
                core.setOutput('is-pr', 'true');
                core.setOutput('pr-number', context.issue.number);
              } else {
                core.setOutput('is-pr', 'false');
              }
            } else {
              core.setOutput('is-pr', 'true'); // workflow_dispatch ä¹Ÿå…è®¸è¿è¡Œ
              core.setOutput('pr-number', '');
            }

  dependency-check:
    needs: check-if-pr
    if: needs.check-if-pr.outputs.is-pr == 'true'
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ PR è¯„è®º

      - name: Check if skip file exists
        id: check-skip-file
        run: |
          if [ -f .github/dependency-check-skip ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°è·³è¿‡æ£€æŸ¥æ–‡ä»¶ (.github/dependency-check-skip)ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR comments for skip keyword
        if: steps.check-skip-file.outputs.skip == 'false'
        id: check-skip-comment
        uses: actions/github-script@v7
        with:
          script: |
            const skipKeywords = [
              '[skip dependency check]',
              '[skip-dependency-check]',
              '[skip dependency-check]',
              '[skip-dependency check]'
            ];
            
            // è·å– PR ç¼–å·
            let prNumber = context.issue.number;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            // æ£€æŸ¥æœ€æ–°çš„è¯„è®ºï¼ˆå¦‚æœæ˜¯ issue_comment äº‹ä»¶ï¼Œæ£€æŸ¥è§¦å‘äº‹ä»¶çš„è¯„è®ºï¼‰
            let hasSkipKeyword = false;
            if (context.eventName === 'issue_comment') {
              // å¦‚æœæ˜¯è¯„è®ºäº‹ä»¶ï¼Œæ£€æŸ¥è§¦å‘äº‹ä»¶çš„è¯„è®º
              const triggerComment = context.payload.comment.body.toLowerCase();
              hasSkipKeyword = skipKeywords.some(keyword => triggerComment.includes(keyword.toLowerCase()));
            }
            
            // ä¹Ÿæ£€æŸ¥æ‰€æœ‰å†å²è¯„è®º
            if (!hasSkipKeyword) {
              hasSkipKeyword = comments.some(comment => {
                const body = comment.body.toLowerCase();
                return skipKeywords.some(keyword => body.includes(keyword.toLowerCase()));
              });
            }
            
            if (hasSkipKeyword) {
              console.log('âœ… åœ¨ PR è¯„è®ºä¸­å‘ç°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥');
              core.setOutput('skip', 'true');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Comment PR when skipped
        if: (steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true') && github.event_name != 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let prNumber = context.issue.number;
            
            let skipReason = '';
            if (fs.existsSync('.github/dependency-check-skip')) {
              skipReason = 'é…ç½®æ–‡ä»¶ (`.github/dependency-check-skip`)';
            } else {
              skipReason = 'PR è¯„è®ºä¸­çš„è·³è¿‡å…³é”®å­—';
            }
            
            const comment = `## â­ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡\n\n` +
              `ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡ ${skipReason}ï¼‰ã€‚\n\n` +
              `âœ… çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶ã€‚\n\n` +
              `---\n\n` +
              `> ğŸ’¡ æç¤ºï¼šå¦‚æœåç»­æœ‰æ–°çš„ commitï¼Œå°†é‡æ–°æ‰§è¡Œä¾èµ–å®‰å…¨æ£€æŸ¥ã€‚`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip check if requested
        if: steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true'
        run: |
          echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆå·²é€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚è·³è¿‡ï¼‰"
          echo "âœ… æ£€æŸ¥å·²è·³è¿‡ï¼ŒçŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸ"
          exit 0

      - name: Set up JDK 17
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Check for dependency updates
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: check-updates
        run: |
          echo "æ£€æŸ¥ä¾èµ–æ›´æ–°..."
          mvn versions:display-dependency-updates -DoutputFile=target/dependency-updates.txt || true
          if [ -f target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
            # è½¬æ¢ä¸º Markdown æ ¼å¼
            if [ -s target/dependency-updates.txt ]; then
              {
                echo "## ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ"
                echo ""
                echo "### åŸå§‹è¾“å‡º"
                echo ""
                echo "\`\`\`"
                cat target/dependency-updates.txt
                echo "\`\`\`"
                echo ""
                echo "### æ›´æ–°æ‘˜è¦ï¼ˆè¡¨æ ¼æ ¼å¼ï¼‰"
                echo ""
                echo "| ä¾èµ–åæ ‡ | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ |"
                echo "|----------|----------|----------|"
                # è§£æ Maven versions æ’ä»¶è¾“å‡ºæ ¼å¼: [INFO]   groupId:artifactId:type:currentVersion -> newVersion
                grep -E "^\[INFO\].*->" target/dependency-updates.txt | \
                  sed 's/\[INFO\]\s*//' | \
                  sed -E 's/^([^:]+:[^:]+:[^:]+):([0-9.]+) -> ([0-9.]+).*/\1 | \2 | \3 |/' | \
                  sed 's/|/|/g' || echo "| æ— å¯ç”¨æ›´æ–° | - | - |"
                echo ""
                echo "> ğŸ’¡ æç¤ºï¼šå»ºè®®å®šæœŸæ›´æ–°ä¾èµ–ä»¥è·å–å®‰å…¨ä¿®å¤å’Œæ–°åŠŸèƒ½"
              } > target/dependency-updates.md
            fi
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: dependency-check
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          mvn verify -DskipTests

      - name: Upload dependency check reports
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/*.html
            target/dependency-check-reports/*.json
            target/dependency-updates.txt
            target/dependency-updates.md
          retention-days: 30

      - name: Comment PR with detailed summary
        if: failure() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è·å– PR ç¼–å·
            let prNumber = context.issue.number;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            }
            
            // è·å– Actions è¿è¡Œé“¾æ¥å’Œ Artifacts é“¾æ¥
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactsUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            // è·å– Artifacts ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆä¸‹è½½é“¾æ¥ï¼‰
            // æ³¨æ„ï¼šGitHub Artifacts éœ€è¦é€šè¿‡ Actions é¡µé¢ä¸‹è½½ï¼Œæ— æ³•ç›´æ¥ç”Ÿæˆä¸‹è½½é“¾æ¥
            // ä½†å¯ä»¥æä¾› Artifacts é¡µé¢çš„é“¾æ¥
            
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= 7.0ï¼‰ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n\n';
            comment += '- **çŠ¶æ€**: âŒ å¤±è´¥\n';
            comment += `- **Actions è¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${runUrl})\n`;
            comment += `- **æŠ¥å‘Šä¸‹è½½**: [ä¸‹è½½ Artifactsï¼ˆåŒ…å« HTML/JSON/TXT æŠ¥å‘Šï¼‰](${artifactsUrl})\n`;
            comment += '  - åœ¨ Actions è¿è¡Œé¡µé¢åº•éƒ¨æ‰¾åˆ° "Artifacts" éƒ¨åˆ†\n';
            comment += '  - ç‚¹å‡» "dependency-check-reports" ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š\n';
            comment += '  - HTML æŠ¥å‘Šï¼š`dependency-check-report.html`ï¼ˆæ¨èï¼Œå¯åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼‰\n';
            comment += '  - JSON æŠ¥å‘Šï¼š`dependency-check-report.json`\n';
            comment += '  - ä¾èµ–æ›´æ–°ï¼š`dependency-updates.txt` å’Œ `dependency-updates.md`\n\n';
            comment += '---\n\n';
            
            // è¯»å–å¹¶è§£æ JSON æŠ¥å‘Šï¼ˆä»…ç”¨äºæå–æ¼æ´ä¿¡æ¯ï¼Œä¸æ˜¾ç¤º JSONï¼‰
            let vulnerabilities = [];
            let txtReportContent = '';
            try {
              const reportPath = 'target/dependency-check-reports/dependency-check-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                if (report.dependencies) {
                  vulnerabilities = report.dependencies
                    .filter(dep => dep.vulnerabilities && dep.vulnerabilities.length > 0)
                    .flatMap(dep => {
                      const depName = dep.packages && dep.packages.length > 0 
                        ? dep.packages[0].name || 'Unknown'
                        : 'Unknown';
                      return dep.vulnerabilities.map(vuln => ({
                        name: depName,
                        cve: vuln.name,
                        severity: vuln.severity || 'Unknown',
                        cvssv3: vuln.cvssv3?.baseScore || vuln.cvssv3?.baseSeverity || vuln.cvssv2?.score || 'N/A',
                        description: vuln.description || '',
                        references: vuln.references || []
                      }));
                    })
                    .sort((a, b) => {
                      const scoreA = parseFloat(a.cvssv3) || 0;
                      const scoreB = parseFloat(b.cvssv3) || 0;
                      return scoreB - scoreA;
                    });
                }
              }
              
              // è¯»å– HTML æŠ¥å‘Šå¹¶è½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
              const htmlReportPath = 'target/dependency-check-reports/dependency-check-report.html';
              if (fs.existsSync(htmlReportPath)) {
                const htmlContent = fs.readFileSync(htmlReportPath, 'utf8');
                // ç®€å•æå–æ–‡æœ¬å†…å®¹ï¼ˆç§»é™¤ HTML æ ‡ç­¾ï¼‰
                txtReportContent = htmlContent
                  .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                  .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                  .replace(/<[^>]+>/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();
              }
            } catch (error) {
              console.log('æ— æ³•è§£ææŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            // æ·»åŠ æ¼æ´åˆ—è¡¨
            if (vulnerabilities.length > 0) {
              comment += '### ğŸš¨ å‘ç°çš„é«˜é£é™©æ¼æ´\n\n';
              comment += `å…±å‘ç° **${vulnerabilities.length}** ä¸ªé«˜é£é™©æ¼æ´ï¼š\n\n`;
              comment += '| ä¾èµ– | CVE | ä¸¥é‡ç¨‹åº¦ | CVSS åˆ†æ•° |\n';
              comment += '|------|-----|----------|----------|\n';
              
              const displayCount = Math.min(vulnerabilities.length, 20);
              vulnerabilities.slice(0, displayCount).forEach(v => {
                const name = (v.name || 'Unknown').replace(/\|/g, '\\|').substring(0, 50);
                const cve = (v.cve || 'Unknown').replace(/\|/g, '\\|');
                const severity = (v.severity || 'Unknown').replace(/\|/g, '\\|');
                comment += `| ${name} | ${cve} | ${severity} | ${v.cvssv3} |\n`;
              });
              
              if (vulnerabilities.length > displayCount) {
                comment += `\n*è¿˜æœ‰ ${vulnerabilities.length - displayCount} ä¸ªæ¼æ´ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š*\n\n`;
              }
              
              comment += '\n---\n\n';
            }
            
            // æ·»åŠ ä¿®å¤å»ºè®®
            comment += '### ğŸ’¡ ä¿®å¤å»ºè®®\n\n';
            comment += '1. **æ›´æ–°ä¾èµ–ç‰ˆæœ¬**ï¼šä¼˜å…ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n';
            comment += '2. **æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**ï¼šä¸‹è½½ HTML æŠ¥å‘ŠæŸ¥çœ‹å®Œæ•´ä¿¡æ¯\n';
            comment += '3. **æ·»åŠ æŠ‘åˆ¶è§„åˆ™**ï¼šå¦‚æœæ¼æ´å¯ä»¥æ¥å—ï¼Œåœ¨ `dependency-check-suppression.xml` ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™\n';
            comment += '4. **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæœ¬æ¬¡ PR ä¸æ¶‰åŠä¾èµ–å˜æ›´ï¼Œå¯ä»¥åœ¨ PR ä¸­æ·»åŠ è¯„è®º `[skip-dependency-check]` è·³è¿‡æ£€æŸ¥\n';
            comment += '5. **é‡æ–°æäº¤**ï¼šä¿®å¤åé‡æ–°æäº¤ PR\n\n';
            comment += '---\n\n';
            
            // æ·»åŠ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆTXT æ ¼å¼ï¼Œå¯æŠ˜å ï¼‰
            if (txtReportContent) {
              comment += '### ğŸ“ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰\n\n';
              comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹åŸå§‹æ–‡æœ¬æŠ¥å‘Šï¼ˆå‰ 2000 å­—ç¬¦ï¼‰</summary>\n\n';
              comment += '```\n';
              
              // é™åˆ¶è¾“å‡ºé•¿åº¦
              const maxChars = 2000;
              const displayContent = txtReportContent.length > maxChars 
                ? txtReportContent.substring(0, maxChars) + `\n\n... (è¿˜æœ‰ ${txtReportContent.length - maxChars} ä¸ªå­—ç¬¦ï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹)`
                : txtReportContent;
              
              comment += displayContent;
              comment += '\n```\n';
              comment += '</details>\n\n';
            }
            
            // æ·»åŠ ä¾èµ–æ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼Œä¹Ÿæ”¾åˆ°å¯æŠ˜å åŒºåŸŸï¼‰
            try {
              const updatesPath = 'target/dependency-updates.txt';
              if (fs.existsSync(updatesPath)) {
                const updatesContent = fs.readFileSync(updatesPath, 'utf8');
                if (updatesContent.trim()) {
                  comment += '---\n\n';
                  comment += '### ğŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ\n\n';
                  comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹ä¾èµ–æ›´æ–°è¯¦æƒ…</summary>\n\n';
                  
                  // è¯»å– Markdown æ ¼å¼çš„æ›´æ–°æŠ¥å‘Š
                  const updatesMdPath = 'target/dependency-updates.md';
                  if (fs.existsSync(updatesMdPath)) {
                    const mdContent = fs.readFileSync(updatesMdPath, 'utf8');
                    comment += mdContent;
                  } else {
                    comment += '```\n';
                    comment += updatesContent.substring(0, 2000);
                    if (updatesContent.length > 2000) {
                      comment += `\n\n... (è¿˜æœ‰ ${updatesContent.length - 2000} ä¸ªå­—ç¬¦)`;
                    }
                    comment += '\n```\n';
                  }
                  
                  comment += '</details>\n';
                }
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æ–‡ä»¶:', error.message);
            }
            
            // å‘é€è¯„è®º
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check scan result
        if: always()
        run: |
          # å¦‚æœè·³è¿‡äº†æ£€æŸ¥ï¼Œç›´æ¥æˆåŠŸé€€å‡º
          if [ "${{ steps.check-skip-file.outputs.skip }}" == "true" ] || [ "${{ steps.check-skip-comment.outputs.skip }}" == "true" ]; then
            echo "âœ… å·²è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰"
            echo "çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶"
            exit 0
          fi
          
          # æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
          if [ "${{ steps.dependency-check.outcome }}" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤ï¼Œæˆ–åœ¨ PR ä¸­æ·»åŠ è¯„è®º [skip-dependency-check] è·³è¿‡æ£€æŸ¥"
            exit 1
          elif [ "${{ steps.dependency-check.outcome }}" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            exit 0
          elif [ "${{ steps.dependency-check.outcome }}" == "skipped" ]; then
            echo "âš ï¸ ä¾èµ–æ£€æŸ¥æ­¥éª¤è¢«è·³è¿‡"
            exit 0
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€æœªçŸ¥: ${{ steps.dependency-check.outcome }}"
            exit 1
          fi
