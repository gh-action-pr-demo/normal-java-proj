name: Dependency Security Check

on:
  pull_request:
    branches:
      - main
      - master
  issue_comment:
    types: [created]
  workflow_dispatch:

# åªåœ¨ PR ç›¸å…³çš„äº‹ä»¶æ—¶è¿è¡Œ
jobs:
  check-if-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      is-pr: ${{ steps.check.outputs.is-pr }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      should-trigger: ${{ steps.check.outputs.should-trigger }}
    steps:
      - name: Check if this is a PR and should trigger
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('is-pr', 'true');
              core.setOutput('pr-number', context.issue.number);
              core.setOutput('should-trigger', 'true');
            } else if (context.eventName === 'issue_comment') {
              // æ£€æŸ¥æ˜¯å¦æ˜¯ PR çš„è¯„è®º
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              if (issue.pull_request) {
                // è·å– PR ä¿¡æ¯ä»¥è·å– head SHA
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number
                });
                
                // æ£€æŸ¥è¯„è®ºä¸­æ˜¯å¦åŒ…å« skip å…³é”®å­—
                const skipKeywords = [
                  '[skip dependency check]',
                  '[skip-dependency-check]',
                  '[skip dependency-check]',
                  '[skip-dependency check]'
                ];
                
                const commentBody = context.payload.comment.body.toLowerCase();
                const hasSkipKeyword = skipKeywords.some(keyword => 
                  commentBody.includes(keyword.toLowerCase())
                );
                
                // åªæœ‰åŒ…å« skip å…³é”®å­—çš„è¯„è®ºæ‰è§¦å‘ workflow
                if (hasSkipKeyword) {
                  core.setOutput('is-pr', 'true');
                  core.setOutput('pr-number', context.issue.number);
                  core.setOutput('should-trigger', 'true');
                  core.setOutput('pr-head-sha', pr.head.sha);
                  console.log('âœ… æ£€æµ‹åˆ°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è§¦å‘ workflow å¹¶è·³è¿‡æ£€æŸ¥');
                } else {
                  core.setOutput('is-pr', 'false');
                  core.setOutput('should-trigger', 'false');
                  console.log('â„¹ï¸ è¯„è®ºä¸­æœªåŒ…å«è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œä¸è§¦å‘ workflow');
                }
              } else {
                core.setOutput('is-pr', 'false');
                core.setOutput('should-trigger', 'false');
              }
            } else {
              core.setOutput('is-pr', 'true'); // workflow_dispatch ä¹Ÿå…è®¸è¿è¡Œ
              core.setOutput('pr-number', '');
              core.setOutput('should-trigger', 'true');
            }

  dependency-check:
    needs: check-if-pr
    if: needs.check-if-pr.outputs.should-trigger == 'true'
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read
      issues: write
      statuses: write

    steps:
      - name: Get PR head SHA for issue_comment event
        if: github.event_name == 'issue_comment'
        id: get-pr-sha
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('pr-head-sha', pr.head.sha);
            console.log(`PR head SHA: ${pr.head.sha}`);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ PR è¯„è®º
          ref: ${{ github.event_name == 'issue_comment' && steps.get-pr-sha.outputs.pr-head-sha || github.event.pull_request.head.sha || github.sha }}

      - name: Check if skip file exists
        id: check-skip-file
        run: |
          if [ -f .github/dependency-check-skip ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°è·³è¿‡æ£€æŸ¥æ–‡ä»¶ (.github/dependency-check-skip)ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR comments for skip keyword
        if: steps.check-skip-file.outputs.skip == 'false'
        id: check-skip-comment
        uses: actions/github-script@v7
        with:
          script: |
            const skipKeywords = [
              '[skip dependency check]',
              '[skip-dependency-check]',
              '[skip dependency-check]',
              '[skip-dependency check]'
            ];
            
            let hasSkipKeyword = false;
            
            if (context.eventName === 'issue_comment') {
              // å¯¹äº issue_comment äº‹ä»¶ï¼šåªæ£€æŸ¥è§¦å‘äº‹ä»¶çš„è¯„è®º
              // è¿™æ ·æ¯æ¬¡è¯„è®ºåªä¼šå½±å“å½“å‰è¿™æ¬¡è§¦å‘ï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºä¼šé‡æ–°æ£€æŸ¥
              const triggerComment = context.payload.comment.body.toLowerCase();
              hasSkipKeyword = skipKeywords.some(keyword => triggerComment.includes(keyword.toLowerCase()));
              
              if (hasSkipKeyword) {
                console.log('âœ… åœ¨è§¦å‘è¯„è®ºä¸­å‘ç°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è·³è¿‡æœ¬æ¬¡ä¾èµ–å®‰å…¨æ£€æŸ¥');
                console.log('â„¹ï¸ æ³¨æ„ï¼šæ­¤è·³è¿‡ä»…å¯¹æœ¬æ¬¡è§¦å‘æœ‰æ•ˆï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºå°†é‡æ–°æ‰§è¡Œæ£€æŸ¥');
              }
            } else if (context.eventName === 'pull_request') {
              // å¯¹äº pull_request äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              // å› ä¸ºè¿™æ˜¯æ–°çš„ commit è§¦å‘çš„ï¼Œåº”è¯¥æ­£å¸¸æ‰§è¡Œæ£€æŸ¥
              // å¦‚æœç”¨æˆ·æƒ³è·³è¿‡ï¼Œåº”è¯¥åœ¨ commit åæ·»åŠ è¯„è®ºæ¥è§¦å‘
              hasSkipKeyword = false;
              console.log('â„¹ï¸ pull_request äº‹ä»¶ï¼šæ­£å¸¸æ‰§è¡Œæ£€æŸ¥ï¼Œä¸æ£€æŸ¥ skip è¯„è®º');
            } else {
              // workflow_dispatch ç­‰å…¶ä»–äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              hasSkipKeyword = false;
            }
            
            if (hasSkipKeyword) {
              core.setOutput('skip', 'true');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Comment PR when skipped
        if: (steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true') && github.event_name != 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let prNumber = context.issue.number;
            
            let skipReason = '';
            if (fs.existsSync('.github/dependency-check-skip')) {
              skipReason = 'é…ç½®æ–‡ä»¶ (`.github/dependency-check-skip`)';
            } else {
              skipReason = 'PR è¯„è®ºä¸­çš„è·³è¿‡å…³é”®å­—';
            }
            
            const comment = `## â­ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡\n\n` +
              `ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡ ${skipReason}ï¼‰ã€‚\n\n` +
              `âœ… çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶ã€‚\n\n` +
              `---\n\n` +
              `> ğŸ’¡ æç¤ºï¼šå¦‚æœåç»­æœ‰æ–°çš„ commitï¼Œå°†é‡æ–°æ‰§è¡Œä¾èµ–å®‰å…¨æ£€æŸ¥ã€‚`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip check if requested
        if: steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true'
        run: |
          echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆå·²é€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚è·³è¿‡ï¼‰"
          echo "âœ… æ£€æŸ¥å·²è·³è¿‡ï¼ŒçŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸ"
          exit 0

      - name: Set up JDK 17
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Check for dependency updates (direct dependencies only)
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: check-updates
        run: |
          echo "æ£€æŸ¥ç›´æ¥ä¾èµ–æ›´æ–°ï¼ˆä¸åŒ…æ‹¬ä¼ é€’ä¾èµ–ï¼‰..."
          mkdir -p target
          # åªæ£€æŸ¥ç›´æ¥ä¾èµ–çš„æ›´æ–°ï¼Œä¸æ£€æŸ¥ä¼ é€’ä¾èµ–
          # ä½¿ç”¨ -DexcludeReactor=false å’Œ -DprocessDependencyManagement=false æ¥åªæ£€æŸ¥ç›´æ¥ä¾èµ–
          mvn versions:display-dependency-updates -DprocessDependencies=true -DprocessDependencyManagement=false -DexcludeReactor=false -DoutputFile=target/dependency-updates.txt 2>&1 | tee target/dependency-updates-raw.txt || true
          
          if [ -f target/dependency-updates.txt ] && [ -s target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
            
            # ä½¿ç”¨å¤–éƒ¨ Python è„šæœ¬ç”Ÿæˆæ ¼å¼åŒ–çš„ Markdown æŠ¥å‘Š
            python3 scripts/parse-dependency-updates.py > target/dependency-updates.md || {
              echo "âš ï¸ Python è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹è¾“å‡º"
              echo "# ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ" > target/dependency-updates.md
              echo "" >> target/dependency-updates.md
              echo "### åŸå§‹è¾“å‡º" >> target/dependency-updates.md
              echo "" >> target/dependency-updates.md
              echo "\`\`\`" >> target/dependency-updates.md
              cat target/dependency-updates.txt >> target/dependency-updates.md
              echo "\`\`\`" >> target/dependency-updates.md
            }
            
            echo "âœ… å·²ç”Ÿæˆä¼˜åŒ–çš„ä¾èµ–æ›´æ–°æŠ¥å‘Šï¼štarget/dependency-updates.md"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¾èµ–æ›´æ–°ä¿¡æ¯æˆ–æ–‡ä»¶ä¸ºç©º"
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: dependency-check
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          mvn verify -DskipTests

      - name: List generated files
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          echo "=== dependency-check-reports ç›®å½• ==="
          ls -lah target/dependency-check-reports/ || echo "ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== target ç›®å½• ==="
          ls -lah target/ | grep -E "(dependency|update)" || echo "æœªæ‰¾åˆ°ç›¸å…³æ–‡ä»¶"

      - name: Upload dependency check reports
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/dependency-check-report.html
            target/dependency-updates.txt
            target/dependency-updates.md
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with detailed summary
        if: failure() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è·å– PR ç¼–å·
            let prNumber = context.issue.number;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            }
            
            // è·å– Actions è¿è¡Œé“¾æ¥å’Œ Artifacts é“¾æ¥
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactsUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            // è·å– Artifacts ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆä¸‹è½½é“¾æ¥ï¼‰
            // æ³¨æ„ï¼šGitHub Artifacts éœ€è¦é€šè¿‡ Actions é¡µé¢ä¸‹è½½ï¼Œæ— æ³•ç›´æ¥ç”Ÿæˆä¸‹è½½é“¾æ¥
            // ä½†å¯ä»¥æä¾› Artifacts é¡µé¢çš„é“¾æ¥
            
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= 7.0ï¼‰ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n\n';
            comment += '- **çŠ¶æ€**: âŒ å¤±è´¥\n';
            comment += `- **Actions è¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${runUrl})\n`;
            comment += `- **æŠ¥å‘Šä¸‹è½½**: [ä¸‹è½½ Artifactsï¼ˆåŒ…å« HTML æŠ¥å‘Šï¼‰](${artifactsUrl})\n`;
            comment += '  - åœ¨ Actions è¿è¡Œé¡µé¢åº•éƒ¨æ‰¾åˆ° "Artifacts" éƒ¨åˆ†\n';
            comment += '  - ç‚¹å‡» "dependency-check-reports" ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š\n';
            comment += '  - HTML æŠ¥å‘Šï¼š`dependency-check-report.html`ï¼ˆæ¨èï¼Œå¯åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æŸ¥çœ‹ï¼‰\n';
            comment += '  - ä¾èµ–æ›´æ–°ï¼š`dependency-updates.txt` å’Œ `dependency-updates.md`\n\n';
            comment += '---\n\n';
            
            // ä» HTML æŠ¥å‘Šä¸­æå–æ¼æ´ä¿¡æ¯ï¼ˆä¸å†ä½¿ç”¨ JSONï¼‰
            let vulnerabilities = [];
            let txtReportContent = '';
            try {
              // è¯»å– HTML æŠ¥å‘Šå¹¶æå–æ¼æ´ä¿¡æ¯
              const htmlReportPath = 'target/dependency-check-reports/dependency-check-report.html';
              if (fs.existsSync(htmlReportPath)) {
                const htmlContent = fs.readFileSync(htmlReportPath, 'utf8');
                
                // æå–æ–‡æœ¬å†…å®¹ï¼ˆç§»é™¤ HTML æ ‡ç­¾ï¼‰
                txtReportContent = htmlContent
                  .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                  .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                  .replace(/<[^>]+>/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();
                
                // ä» HTML ä¸­æå–æ¼æ´ä¿¡æ¯ï¼ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼‰
                // æŸ¥æ‰¾åŒ…å« CVE çš„è¡Œ
                const cvePattern = /CVE-\d{4}-\d+/gi;
                const severityPattern = /(CRITICAL|HIGH|MEDIUM|LOW)/gi;
                
                // å°è¯•ä» HTML è¡¨æ ¼ä¸­æå–æ¼æ´ä¿¡æ¯
                const tableRows = htmlContent.match(/<tr[^>]*>[\s\S]*?<\/tr>/gi) || [];
                const vulnRows = tableRows.filter(row => row.includes('CVE-'));
                
                vulnRows.forEach(row => {
                  const cveMatch = row.match(/CVE-\d{4}-\d+/i);
                  const severityMatch = row.match(/(CRITICAL|HIGH|MEDIUM|LOW)/i);
                  const cvssMatch = row.match(/CVSS[^>]*>([0-9.]+)/i);
                  
                  if (cveMatch) {
                    vulnerabilities.push({
                      name: 'Direct Dependency',
                      cve: cveMatch[0],
                      severity: severityMatch ? severityMatch[1] : 'Unknown',
                      cvssv3: cvssMatch ? cvssMatch[1] : 'N/A'
                    });
                  }
                });
                
                // å»é‡å¹¶æŒ‰ CVSS åˆ†æ•°æ’åº
                vulnerabilities = vulnerabilities
                  .filter((v, index, self) => 
                    index === self.findIndex(t => t.cve === v.cve)
                  )
                  .sort((a, b) => {
                    const scoreA = parseFloat(a.cvssv3) || 0;
                    const scoreB = parseFloat(b.cvssv3) || 0;
                    return scoreB - scoreA;
                  });
              }
            } catch (error) {
              console.log('æ— æ³•è§£ææŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            // æ·»åŠ æ¼æ´åˆ—è¡¨
            if (vulnerabilities.length > 0) {
              comment += '### ğŸš¨ å‘ç°çš„é«˜é£é™©æ¼æ´\n\n';
              comment += `å…±å‘ç° **${vulnerabilities.length}** ä¸ªé«˜é£é™©æ¼æ´ï¼š\n\n`;
              comment += '| ä¾èµ– | CVE | ä¸¥é‡ç¨‹åº¦ | CVSS åˆ†æ•° |\n';
              comment += '|------|-----|----------|----------|\n';
              
              const displayCount = Math.min(vulnerabilities.length, 20);
              vulnerabilities.slice(0, displayCount).forEach(v => {
                const name = (v.name || 'Unknown').replace(/\|/g, '\\|').substring(0, 50);
                const cve = (v.cve || 'Unknown').replace(/\|/g, '\\|');
                const severity = (v.severity || 'Unknown').replace(/\|/g, '\\|');
                comment += `| ${name} | ${cve} | ${severity} | ${v.cvssv3} |\n`;
              });
              
              if (vulnerabilities.length > displayCount) {
                comment += `\n*è¿˜æœ‰ ${vulnerabilities.length - displayCount} ä¸ªæ¼æ´ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š*\n\n`;
              }
              
              comment += '\n---\n\n';
            }
            
            // æ·»åŠ ä¿®å¤å»ºè®®
            comment += '### ğŸ’¡ ä¿®å¤å»ºè®®\n\n';
            comment += '1. **æ›´æ–°ä¾èµ–ç‰ˆæœ¬**ï¼šä¼˜å…ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n';
            comment += '2. **æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**ï¼šä¸‹è½½ HTML æŠ¥å‘ŠæŸ¥çœ‹å®Œæ•´ä¿¡æ¯\n';
            comment += '3. **æ·»åŠ æŠ‘åˆ¶è§„åˆ™**ï¼šå¦‚æœæ¼æ´å¯ä»¥æ¥å—ï¼Œåœ¨ `dependency-check-suppression.xml` ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™\n';
            comment += '4. **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæœ¬æ¬¡ PR ä¸æ¶‰åŠä¾èµ–å˜æ›´ï¼Œå¯ä»¥åœ¨ PR ä¸­æ·»åŠ è¯„è®º `[skip-dependency-check]` è·³è¿‡æ£€æŸ¥\n';
            comment += '5. **é‡æ–°æäº¤**ï¼šä¿®å¤åé‡æ–°æäº¤ PR\n\n';
            comment += '---\n\n';
            
            // æ·»åŠ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆTXT æ ¼å¼ï¼Œå¯æŠ˜å ï¼‰
            if (txtReportContent) {
              comment += '### ğŸ“ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰\n\n';
              comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹åŸå§‹æ–‡æœ¬æŠ¥å‘Šï¼ˆå‰ 2000 å­—ç¬¦ï¼‰</summary>\n\n';
              comment += '```\n';
              
              // é™åˆ¶è¾“å‡ºé•¿åº¦
              const maxChars = 2000;
              const displayContent = txtReportContent.length > maxChars 
                ? txtReportContent.substring(0, maxChars) + `\n\n... (è¿˜æœ‰ ${txtReportContent.length - maxChars} ä¸ªå­—ç¬¦ï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹)`
                : txtReportContent;
              
              comment += displayContent;
              comment += '\n```\n';
              comment += '</details>\n\n';
            }
            
            // æ·»åŠ ä¾èµ–æ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼Œä¹Ÿæ”¾åˆ°å¯æŠ˜å åŒºåŸŸï¼‰
            try {
              const updatesPath = 'target/dependency-updates.txt';
              if (fs.existsSync(updatesPath)) {
                const updatesContent = fs.readFileSync(updatesPath, 'utf8');
                if (updatesContent.trim()) {
                  comment += '---\n\n';
                  comment += '### ğŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ\n\n';
                  comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹ä¾èµ–æ›´æ–°è¯¦æƒ…</summary>\n\n';
                  
                  // è¯»å– Markdown æ ¼å¼çš„æ›´æ–°æŠ¥å‘Š
                  const updatesMdPath = 'target/dependency-updates.md';
                  if (fs.existsSync(updatesMdPath)) {
                    const mdContent = fs.readFileSync(updatesMdPath, 'utf8');
                    comment += mdContent;
                  } else {
                    comment += '```\n';
                    comment += updatesContent.substring(0, 2000);
                    if (updatesContent.length > 2000) {
                      comment += `\n\n... (è¿˜æœ‰ ${updatesContent.length - 2000} ä¸ªå­—ç¬¦)`;
                    }
                    comment += '\n```\n';
                  }
                  
                  comment += '</details>\n';
                }
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æ–‡ä»¶:', error.message);
            }
            
            // å‘é€è¯„è®º
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Report status check result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // æ£€æŸ¥æ˜¯å¦è·³è¿‡äº†æ£€æŸ¥
            const skipFile = process.env.SKIP_FILE === 'true';
            const skipComment = process.env.SKIP_COMMENT === 'true';
            const skipped = skipFile || skipComment;
            
            // è·å– PR ç¼–å·å’Œ SHA
            let prNumber = context.issue.number;
            let sha = context.sha;
            
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
              // è·å– PR çš„ head SHA
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              sha = pr.head.sha;
            } else if (context.eventName === 'pull_request') {
              sha = context.payload.pull_request.head.sha;
            }
            
            if (skipped) {
              // è·³è¿‡æ£€æŸ¥æ—¶ï¼ŒæŠ¥å‘ŠæˆåŠŸçŠ¶æ€
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                state: 'success',
                context: 'Dependency Security Check / OWASP Dependency Check',
                description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰',
                target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
              console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰');
            } else {
              // æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
              const checkOutcome = process.env.CHECK_OUTCOME || 'unknown';
              
              if (checkOutcome === 'failure') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'failure',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âŒ çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºå¤±è´¥');
              } else if (checkOutcome === 'success') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'success',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸ');
              }
            }

      - name: Check scan result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        run: |
          # å¦‚æœè·³è¿‡äº†æ£€æŸ¥ï¼Œç›´æ¥æˆåŠŸé€€å‡º
          if [ "$SKIP_FILE" == "true" ] || [ "$SKIP_COMMENT" == "true" ]; then
            echo "âœ… å·²è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰"
            echo "çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶"
            exit 0
          fi
          
          # æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
          if [ "$CHECK_OUTCOME" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤ï¼Œæˆ–åœ¨ PR ä¸­æ·»åŠ è¯„è®º [skip-dependency-check] è·³è¿‡æ£€æŸ¥"
            exit 1
          elif [ "$CHECK_OUTCOME" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            exit 0
          elif [ "$CHECK_OUTCOME" == "skipped" ]; then
            echo "âš ï¸ ä¾èµ–æ£€æŸ¥æ­¥éª¤è¢«è·³è¿‡"
            exit 0
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€æœªçŸ¥: $CHECK_OUTCOME"
            exit 1
          fi
