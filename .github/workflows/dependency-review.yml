name: Dependency Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: read

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Init PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.setOutput('prNumber', String(pr.number));
            core.setOutput('baseSha', pr.base.sha);
            core.setOutput('headSha', pr.head.sha);
      - name: Check skip keywords in PR comments
        id: skipchk
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            const patterns = [
              /\[skip dependency check\]/i,
              /\[skip-dependency-check\]/i,
              /\[skip dependency-check\]/i,
              /\[skip-dependency check\]/i
            ];
            const latest = comments.length ? comments[comments.length - 1] : { body: '' };
            const hasSkip = patterns.some(p => p.test(latest.body || ''));
            core.setOutput('skip', String(hasSkip));

      - name: Skip notice
        if: steps.skipchk.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body: "✅ 已根据评论关键字跳过依赖变更审查（Dependency Review）。"
            });

      - name: Early exit after skip
        if: steps.skipchk.outputs.skip == 'true'
        run: echo "Skipped by keyword." && exit 0

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

      - name: Post dependency diff summary to PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = "${{ steps.ctx.outputs.baseSha }}";
            const head = "${{ steps.ctx.outputs.headSha }}";
            let lines = [];
            try {
              const res = await github.request('GET /repos/{owner}/{repo}/dependency-graph/compare/{basehead}', {
                owner,
                repo,
                basehead: `${base}...${head}`,
                headers: { 'X-GitHub-Api-Version': '2022-11-28' }
              });
              const diff = res.data || {};
              const changes = diff.change_type ? [diff] : (diff.changed_manifests || []);
              if (Array.isArray(changes) && changes.length > 0) {
                lines.push('### Dependency Review 摘要');
                for (const ch of changes) {
                  const manifest = ch.manifest || ch.name || '';
                  const vulns = ch.vulnerabilities || ch.advisories || [];
                  if (vulns.length > 0) {
                    lines.push(`- ${manifest}: 检测到 ${vulns.length} 条风险`);
                    for (const v of vulns.slice(0, 20)) {
                      const sev = v.severity || v.cvss_severity || v.database_specific?.severity || 'unknown';
                      const pkg = v.package?.name || v.dependency?.package || '';
                      const adv = v.ghsa_id || v.advisory_ghsa_id || v.advisory_id || '';
                      lines.push(`  - ${pkg} | 严重级别: ${sev} | ${adv}`);
                    }
                  }
                }
              }
            } catch (e) {
              lines.push('ℹ️ 无法通过 API 获取依赖差异摘要，已退回官方评论。');
            }
            if (lines.length === 0) {
              lines.push('✅ Dependency Review 已完成，未获取到可用摘要或无风险。详情见本次检查的官方评论与日志。');
            }
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body: lines.join('\n')
            });

      - name: Post filtered summary comment
        if: startsWith(github.event_name, 'pull_request')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '.github/ignore-deps.txt';
            let ignored = [];
            if (fs.existsSync(path)) {
              ignored = fs.readFileSync(path, 'utf8')
                .split('\n')
                .map(s => s.trim())
                .filter(s => s && !s.startsWith('#'));
            }
            const header = 'Dependency Review（过滤后摘要）';
            const bodyLines = [];
            if (ignored.length) {
              bodyLines.push('已忽略的依赖（按规则文件）：');
              for (const item of ignored) bodyLines.push(`- ${item}`);
              bodyLines.push('');
            } else {
              bodyLines.push('无忽略规则。');
              bodyLines.push('');
            }
            bodyLines.push('完整明细请查看本次 Actions 运行页面的 Dependency Review 日志。');
            const body = `### ${header}\n\n` + bodyLines.join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body
            });


