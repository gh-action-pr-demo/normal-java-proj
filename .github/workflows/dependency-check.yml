name: Dependency Security Check

on:
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ PR è¯„è®º

      - name: Check if skip file exists
        id: check-skip-file
        run: |
          if [ -f .github/dependency-check-skip ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°è·³è¿‡æ£€æŸ¥æ–‡ä»¶ (.github/dependency-check-skip)ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR comments for skip keyword
        if: github.event_name == 'pull_request' && steps.check-skip-file.outputs.skip == 'false'
        id: check-skip-comment
        uses: actions/github-script@v7
        with:
          script: |
            const skipKeywords = [
              '[skip dependency check]',
              '[skip-dependency-check]',
              '[skip dependency-check]',
              '[skip-dependency check]'
            ];
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const hasSkipKeyword = comments.some(comment => {
              const body = comment.body.toLowerCase();
              return skipKeywords.some(keyword => body.includes(keyword.toLowerCase()));
            });
            
            if (hasSkipKeyword) {
              console.log('âœ… åœ¨ PR è¯„è®ºä¸­å‘ç°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥');
              core.setOutput('skip', 'true');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Skip check if requested
        if: steps.check-skip-file.outputs.skip == 'true' || (github.event_name == 'pull_request' && steps.check-skip-comment.outputs.skip == 'true')
        run: |
          echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆå·²é€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚è·³è¿‡ï¼‰"
          exit 0

      - name: Set up JDK 17
        if: steps.check-skip-file.outputs.skip != 'true' && (github.event_name != 'pull_request' || steps.check-skip-comment.outputs.skip != 'true')
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Check for dependency updates
        if: steps.check-skip-file.outputs.skip != 'true' && (github.event_name != 'pull_request' || steps.check-skip-comment.outputs.skip != 'true')
        id: check-updates
        run: |
          echo "æ£€æŸ¥ä¾èµ–æ›´æ–°..."
          mvn versions:display-dependency-updates -DoutputFile=target/dependency-updates.txt || true
          if [ -f target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
            # è½¬æ¢ä¸º Markdown æ ¼å¼
            if [ -s target/dependency-updates.txt ]; then
              {
                echo "## ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ"
                echo ""
                echo "### åŸå§‹è¾“å‡º"
                echo ""
                echo "\`\`\`"
                cat target/dependency-updates.txt
                echo "\`\`\`"
                echo ""
                echo "### æ›´æ–°æ‘˜è¦ï¼ˆè¡¨æ ¼æ ¼å¼ï¼‰"
                echo ""
                echo "| ä¾èµ–åæ ‡ | å½“å‰ç‰ˆæœ¬ | æœ€æ–°ç‰ˆæœ¬ |"
                echo "|----------|----------|----------|"
                # è§£æ Maven versions æ’ä»¶è¾“å‡ºæ ¼å¼: [INFO]   groupId:artifactId:type:currentVersion -> newVersion
                grep -E "^\[INFO\].*->" target/dependency-updates.txt | \
                  sed 's/\[INFO\]\s*//' | \
                  sed -E 's/^([^:]+:[^:]+:[^:]+):([0-9.]+) -> ([0-9.]+).*/\1 | \2 | \3 |/' | \
                  sed 's/|/|/g' || echo "| æ— å¯ç”¨æ›´æ–° | - | - |"
                echo ""
                echo "> ğŸ’¡ æç¤ºï¼šå»ºè®®å®šæœŸæ›´æ–°ä¾èµ–ä»¥è·å–å®‰å…¨ä¿®å¤å’Œæ–°åŠŸèƒ½"
              } > target/dependency-updates.md
            fi
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        if: steps.check-skip-file.outputs.skip != 'true' && (github.event_name != 'pull_request' || steps.check-skip-comment.outputs.skip != 'true')
        id: dependency-check
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          mvn verify -DskipTests

      - name: Upload dependency check reports
        if: always() && steps.check-skip-file.outputs.skip != 'true' && (github.event_name != 'pull_request' || steps.check-skip-comment.outputs.skip != 'true')
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/*.html
            target/dependency-check-reports/*.json
            target/dependency-updates.txt
            target/dependency-updates.md
          retention-days: 30

      - name: Comment PR with detailed summary
        if: failure() && github.event_name == 'pull_request' && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è·å– Actions è¿è¡Œé“¾æ¥
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactsUrl = `${runUrl}#artifacts`;
            
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= 7.0ï¼‰ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n\n';
            comment += '- **çŠ¶æ€**: âŒ å¤±è´¥\n';
            comment += `- **Actions è¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${runUrl})\n`;
            comment += `- **è¯¦ç»†æŠ¥å‘Š**: [ä¸‹è½½ Artifacts](${artifactsUrl})\n\n`;
            comment += '---\n\n';
            
            // è¯»å–å¹¶è§£æ JSON æŠ¥å‘Š
            let vulnerabilities = [];
            let rawReportContent = '';
            try {
              const reportPath = 'target/dependency-check-reports/dependency-check-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                rawReportContent = JSON.stringify(report, null, 2);
                
                if (report.dependencies) {
                  vulnerabilities = report.dependencies
                    .filter(dep => dep.vulnerabilities && dep.vulnerabilities.length > 0)
                    .flatMap(dep => {
                      const depName = dep.packages && dep.packages.length > 0 
                        ? dep.packages[0].name || 'Unknown'
                        : 'Unknown';
                      return dep.vulnerabilities.map(vuln => ({
                        name: depName,
                        cve: vuln.name,
                        severity: vuln.severity || 'Unknown',
                        cvssv3: vuln.cvssv3?.baseScore || vuln.cvssv3?.baseSeverity || vuln.cvssv2?.score || 'N/A',
                        description: vuln.description || '',
                        references: vuln.references || []
                      }));
                    })
                    .sort((a, b) => {
                      const scoreA = parseFloat(a.cvssv3) || 0;
                      const scoreB = parseFloat(b.cvssv3) || 0;
                      return scoreB - scoreA;
                    });
                }
              }
            } catch (error) {
              console.log('æ— æ³•è§£ææŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            // æ·»åŠ æ¼æ´åˆ—è¡¨
            if (vulnerabilities.length > 0) {
              comment += '### ğŸš¨ å‘ç°çš„é«˜é£é™©æ¼æ´\n\n';
              comment += `å…±å‘ç° **${vulnerabilities.length}** ä¸ªé«˜é£é™©æ¼æ´ï¼š\n\n`;
              comment += '| ä¾èµ– | CVE | ä¸¥é‡ç¨‹åº¦ | CVSS åˆ†æ•° |\n';
              comment += '|------|-----|----------|----------|\n';
              
              const displayCount = Math.min(vulnerabilities.length, 20);
              vulnerabilities.slice(0, displayCount).forEach(v => {
                const name = (v.name || 'Unknown').replace(/\|/g, '\\|').substring(0, 50);
                const cve = (v.cve || 'Unknown').replace(/\|/g, '\\|');
                const severity = (v.severity || 'Unknown').replace(/\|/g, '\\|');
                comment += `| ${name} | ${cve} | ${severity} | ${v.cvssv3} |\n`;
              });
              
              if (vulnerabilities.length > displayCount) {
                comment += `\n*è¿˜æœ‰ ${vulnerabilities.length - displayCount} ä¸ªæ¼æ´ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š*\n\n`;
              }
              
              comment += '\n---\n\n';
            }
            
            // æ·»åŠ ä¿®å¤å»ºè®®
            comment += '### ğŸ’¡ ä¿®å¤å»ºè®®\n\n';
            comment += '1. **æ›´æ–°ä¾èµ–ç‰ˆæœ¬**ï¼šä¼˜å…ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n';
            comment += '2. **æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**ï¼šä¸‹è½½ Artifacts ä¸­çš„ HTML æŠ¥å‘ŠæŸ¥çœ‹å®Œæ•´ä¿¡æ¯\n';
            comment += '3. **æ·»åŠ æŠ‘åˆ¶è§„åˆ™**ï¼šå¦‚æœæ¼æ´å¯ä»¥æ¥å—ï¼Œåœ¨ `dependency-check-suppression.xml` ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™\n';
            comment += '4. **é‡æ–°æäº¤**ï¼šä¿®å¤åé‡æ–°æäº¤ PR\n\n';
            comment += '---\n\n';
            
            // æ·»åŠ åŸå§‹æ£€æŸ¥ç»“æœï¼ˆMarkdown ä»£ç å—ï¼‰
            comment += '### ğŸ“ åŸå§‹æ£€æŸ¥ç»“æœ\n\n';
            comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹åŸå§‹ JSON æŠ¥å‘Šï¼ˆå‰ 1000 è¡Œï¼‰</summary>\n\n';
            comment += '```json\n';
            
            // é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…è¯„è®ºè¿‡é•¿
            const maxLines = 1000;
            const lines = rawReportContent.split('\n');
            const displayLines = lines.slice(0, maxLines);
            comment += displayLines.join('\n');
            
            if (lines.length > maxLines) {
              comment += `\n\n... (è¿˜æœ‰ ${lines.length - maxLines} è¡Œï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹)\n`;
            }
            
            comment += '\n```\n';
            comment += '</details>\n';
            
            // æ·»åŠ ä¾èµ–æ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            try {
              const updatesPath = 'target/dependency-updates.md';
              if (fs.existsSync(updatesPath)) {
                const updatesContent = fs.readFileSync(updatesPath, 'utf8');
                if (updatesContent.trim()) {
                  comment += '\n---\n\n';
                  comment += '### ğŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ\n\n';
                  comment += updatesContent;
                }
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æ–‡ä»¶:', error.message);
            }
            
            // å‘é€è¯„è®º
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check scan result
        if: always()
        run: |
          if [ "${{ steps.check-skip-file.outputs.skip }}" == "true" ] || [ "${{ steps.check-skip-comment.outputs.skip }}" == "true" ]; then
            echo "âœ… å·²è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
            exit 0
          elif [ "${{ steps.dependency-check.outcome }}" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤"
            exit 1
          elif [ "${{ steps.dependency-check.outcome }}" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            exit 0
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€: ${{ steps.dependency-check.outcome }}"
            exit 1
          fi
