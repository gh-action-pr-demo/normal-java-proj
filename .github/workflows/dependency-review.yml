name: Dependency Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  issues:
    types: [labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR number from context
        id: get-pr-number
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'issues') {
              // ä» issues.labeled/unlabeled äº‹ä»¶è·å– PR å·
              // åªåœ¨æ·»åŠ æˆ–ç§»é™¤ dependency-check-ignore æ ‡ç­¾æ—¶è§¦å‘
              const labelName = context.payload.label?.name;
              const action = context.payload.action; // 'labeled' æˆ– 'unlabeled'
              
              console.log(`=== æ ‡ç­¾äº‹ä»¶è§¦å‘ ===`);
              console.log(`äº‹ä»¶ç±»å‹: ${context.eventName}`);
              console.log(`åŠ¨ä½œ: ${action}`);
              console.log(`æ ‡ç­¾åç§°: ${labelName}`);
              console.log(`Issue Number: ${context.payload.issue?.number}`);
              
              if (labelName !== 'dependency-check-ignore') {
                console.log(`æ ‡ç­¾ ${labelName} ä¸æ˜¯ dependency-check-ignoreï¼Œè·³è¿‡`);
                core.setOutput('is_pr', 'false');
                return;
              }
              
              prNumber = context.payload.issue.number;
              // éªŒè¯æ˜¯å¦æ˜¯ PR
              if (!context.payload.issue.pull_request) {
                console.log('è¿™ä¸æ˜¯ PRï¼Œè·³è¿‡');
                core.setOutput('is_pr', 'false');
                return;
              }
              
              if (action === 'labeled') {
                console.log(`æ£€æµ‹åˆ°æ·»åŠ  dependency-check-ignore æ ‡ç­¾ï¼Œè§¦å‘ä¾èµ–æ£€æŸ¥`);
              } else if (action === 'unlabeled') {
                console.log(`æ£€æµ‹åˆ°ç§»é™¤ dependency-check-ignore æ ‡ç­¾ï¼Œè§¦å‘ä¾èµ–æ£€æŸ¥`);
              }
            } else {
              // ä» pull_request äº‹ä»¶è·å– PR å·
              prNumber = context.payload.pull_request.number;
            }
            
            core.setOutput('pr_number', prNumber.toString());
            core.setOutput('is_pr', 'true');
            console.log(`PR Number: ${prNumber}, Event: ${context.eventName}`);

      - name: Checkout repository
        if: steps.get-pr-number.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if dependency check is ignored
        id: check-ignored
        if: steps.get-pr-number.outputs.is_pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(prNumber)
            });
            
            const labels = issue.labels.map(l => l.name);
            const isIgnored = labels.includes('dependency-check-ignore');
            
            console.log(`PR æ ‡ç­¾: ${labels.join(', ')}`);
            console.log(`æ˜¯å¦å¿½ç•¥æ£€æŸ¥: ${isIgnored}`);
            
            core.setOutput('ignored', isIgnored.toString());
            
            if (isIgnored) {
              console.log('ä¾èµ–æ£€æŸ¥å·²è¢«å¿½ç•¥ï¼Œè·³è¿‡æ£€æŸ¥');
            }

      - name: Skip if ignored and post comment
        if: steps.check-ignored.outputs.ignored == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            
            // è·å– PR è¯¦æƒ…
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // åˆ›å»ºè¯„è®ºè¯´æ˜æ˜¯å› ä¸ºæ ‡ç­¾è·³è¿‡æ£€æŸ¥
            let skipComment = `## ğŸ”’ Dependency Review\n\n`;
            skipComment += `â­ï¸ **ä¾èµ–æ£€æŸ¥å·²è·³è¿‡**\n\n`;
            skipComment += `**åŸå› **: PR å·²æ·»åŠ  \`dependency-check-ignore\` æ ‡ç­¾\n\n`;
            skipComment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
            skipComment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š æŸ¥çœ‹ Actions è¿è¡Œè¯¦æƒ…</a>\n\n`;
            skipComment += `**æç¤º**: å¦‚éœ€é‡æ–°å¯ç”¨æ£€æŸ¥ï¼Œè¯·ç§»é™¤ \`dependency-check-ignore\` æ ‡ç­¾ã€‚\n\n`;
            skipComment += `---\n`;
            skipComment += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: skipComment
              });
              console.log('å·²åˆ›å»º"è·³è¿‡æ£€æŸ¥"çš„è¯„è®º');
            } catch (error) {
              console.error('åˆ›å»ºè¯„è®ºå¤±è´¥:', error);
            }
            
            // åˆ›å»ºä¸€ä¸ªæˆåŠŸçš„ check run æ¥è¦†ç›–ä¹‹å‰çš„å¤±è´¥çŠ¶æ€
            try {
              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Dependency Review',
                head_sha: pr.head.sha,
                status: 'completed',
                conclusion: 'success',
                output: {
                  title: 'ä¾èµ–æ£€æŸ¥å·²è·³è¿‡',
                  summary: 'æ­¤ PR å·²æ·»åŠ  `dependency-check-ignore` æ ‡ç­¾ï¼Œä¾èµ–æ£€æŸ¥å·²è·³è¿‡ã€‚'
                }
              });
              console.log('å·²åˆ›å»ºæˆåŠŸçš„ check run');
            } catch (checkError) {
              console.error('åˆ›å»º check run å¤±è´¥:', checkError);
            }
            
            // é€€å‡ºæˆåŠŸ
            process.exit(0);

      - name: Get PR details for dependency review
        id: get-pr-details
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt(prNumber)
            });
            
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_sha', pr.base.sha);
            console.log(`Head SHA: ${pr.head.sha}`);
            console.log(`Base SHA: ${pr.base.sha}`);

      - name: Set up JDK
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven (to generate dependency graph)
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        run: |
          mvn clean compile -DskipTests || echo "æ„å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ£€æŸ¥ä¾èµ–"
          echo "Maven æ„å»ºå®Œæˆï¼Œä¾èµ–å›¾å·²ç”Ÿæˆ"

      - name: Dependency Review
        id: dep-review
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        continue-on-error: true
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          # ç¦ç”¨è‡ªåŠ¨è¯„è®ºï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­æ­¥éª¤ä¸­æ‰‹åŠ¨åˆ›å»ºè¯„è®º
          comment-summary-in-pr: always

      - name: Debug - Check dependencies
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        run: |
          echo "=== æ£€æŸ¥ pom.xml æ–‡ä»¶ ==="
          find . -name "pom.xml" -type f
          echo ""
          echo "=== module-service/pom.xml å†…å®¹ ==="
          cat module-service/pom.xml 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥ log4j ä¾èµ– ==="
          grep -r "log4j" --include="*.xml" . || echo "æœªæ‰¾åˆ° log4j"
          echo ""
          echo "=== Dependency Review è¾“å‡ºçŠ¶æ€ ==="
          echo "Outcome: ${{ steps.dep-review.outcome }}"
          echo "Exit code: ${{ steps.dep-review.exit-code }}"

      - name: Get dependency review results and post comment
        id: get-results
        # åªåœ¨æ²¡æœ‰å¿½ç•¥æ ‡ç­¾æ—¶æ‰§è¡Œï¼Œå¦‚æœæœ‰æ ‡ç­¾åˆ™è·³è¿‡ï¼ˆå› ä¸ºå·²ç»åœ¨ Skip if ignored æ­¥éª¤ä¸­å¤„ç†äº†ï¼‰
        if: steps.get-pr-number.outputs.is_pr == 'true' && steps.check-ignored.outputs.ignored != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const prNumber = '${{ steps.get-pr-number.outputs.pr_number }}';
              
              // è·å– PR è¯¦æƒ…ä»¥è·å– SHA
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(prNumber)
              });
              
              // æ£€æŸ¥æ˜¯å¦æœ‰å¿½ç•¥æ ‡ç­¾ï¼ˆåŒé‡æ£€æŸ¥ï¼Œç¡®ä¿ä¸ä¼šåœ¨æœ‰æ ‡ç­¾æ—¶æ‰§è¡Œï¼‰
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber)
              });
              
              const labels = issue.labels.map(l => l.name);
              const isIgnored = labels.includes('dependency-check-ignore');
              
              if (isIgnored) {
                console.log('æ£€æµ‹åˆ°å¿½ç•¥æ ‡ç­¾ï¼Œè·³è¿‡è¯„è®ºåˆ›å»ºï¼ˆåº”è¯¥åœ¨ Skip if ignored æ­¥éª¤ä¸­å·²å¤„ç†ï¼‰');
                return;
              }
              
              const depReviewOutcome = '${{ steps.dep-review.outcome }}';
              const hasVulnerabilities = depReviewOutcome === 'failure';
              
              console.log(`Dependency Review ç»“æœ: ${depReviewOutcome}`);
              console.log(`æ˜¯å¦æ£€æµ‹åˆ°æ¼æ´: ${hasVulnerabilities}`);
              console.log(`Head SHA: ${pr.head.sha}`);
              console.log(`Base SHA: ${pr.base.sha}`);
              console.log(`Run ID: ${context.runId}`);
              
              // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°æ¼æ´ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªè¯„è®ºè¯´æ˜
              if (!hasVulnerabilities) {
                const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
                let noVulnComment = `## ğŸ”’ Dependency Review\n\n`;
                noVulnComment += `âœ… **æœªæ£€æµ‹åˆ°é«˜ä¸¥é‡ç¨‹åº¦çš„å®‰å…¨æ¼æ´**\n\n`;
                noVulnComment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
                noVulnComment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Š</a>\n\n`;
                noVulnComment += `**æ³¨æ„**: å¦‚æœé¢„æœŸåº”è¯¥æ£€æµ‹åˆ°æ¼æ´ï¼ˆå¦‚ log4j 2.13.0ï¼‰ï¼Œè¯·æ£€æŸ¥ï¼š\n`;
                noVulnComment += `1. ä¾èµ–æ˜¯å¦æ­£ç¡®æ·»åŠ åˆ° pom.xml\n`;
                noVulnComment += `2. GitHub Dependency Graph æ˜¯å¦å·²æ›´æ–°\n`;
                noVulnComment += `3. æŸ¥çœ‹ Actions summary é¡µé¢çš„è¯¦ç»†æ—¥å¿—\n\n`;
                noVulnComment += `---\n`;
                noVulnComment += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: noVulnComment
                });
                console.log('å·²åˆ›å»º"æœªæ£€æµ‹åˆ°æ¼æ´"çš„è¯„è®º');
                return;
              }
              
              console.log('æ£€æµ‹åˆ°æ¼æ´ï¼Œå¼€å§‹ç”ŸæˆæŠ¥å‘Š...');
              
              // ä½¿ç”¨ Dependency Graph API è·å–æ¼æ´è¯¦æƒ…
              let vulnerabilities = [];
              try {
                console.log('å°è¯•è·å– base åˆ†æ”¯çš„ä¾èµ–ä¿¡æ¯...');
                const { data: baseDiff } = await github.rest.dependencyGraph.diffRange({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  basehead: `${pr.base.sha}^...${pr.base.sha}`
                });
                console.log(`Base åˆ†æ”¯æ¼æ´æ•°: ${baseDiff.vulnerabilities?.length || 0}`);
                
                console.log('å°è¯•è·å– head åˆ†æ”¯çš„ä¾èµ–ä¿¡æ¯...');
                const { data: headDiff } = await github.rest.dependencyGraph.diffRange({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  basehead: `${pr.head.sha}^...${pr.head.sha}`
                });
                console.log(`Head åˆ†æ”¯æ¼æ´æ•°: ${headDiff.vulnerabilities?.length || 0}`);
                
                // è·å– PR diff ä¸­çš„æ¼æ´ï¼ˆæ–°å¼•å…¥çš„ï¼‰
                const { data: prDiff } = await github.rest.dependencyGraph.diffRange({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  basehead: `${pr.base.sha}...${pr.head.sha}`
                });
                console.log(`PR diff æ¼æ´æ•°: ${prDiff.vulnerabilities?.length || 0}`);
                
                // ä¼˜å…ˆä½¿ç”¨ head åˆ†æ”¯çš„æ‰€æœ‰æ¼æ´ï¼ˆåŒ…æ‹¬å·²å­˜åœ¨çš„ï¼‰
                if (headDiff.vulnerabilities && headDiff.vulnerabilities.length > 0) {
                  vulnerabilities = headDiff.vulnerabilities;
                  console.log(`ä½¿ç”¨ head åˆ†æ”¯çš„æ¼æ´: ${vulnerabilities.length} ä¸ª`);
                } else if (prDiff.vulnerabilities && prDiff.vulnerabilities.length > 0) {
                  vulnerabilities = prDiff.vulnerabilities;
                  console.log(`ä½¿ç”¨ PR diff çš„æ¼æ´: ${vulnerabilities.length} ä¸ª`);
                }
              } catch (apiError) {
                console.log('Dependency Graph API è°ƒç”¨å¤±è´¥:', apiError.message);
                console.log('é”™è¯¯è¯¦æƒ…:', JSON.stringify(apiError, null, 2));
                // ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿æ— æ³•è·å–è¯¦ç»†æ¼æ´ä¿¡æ¯
              }
              
              // æ„å»º Actions summary é¡µé¢é“¾æ¥
              const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              // åˆ›å»ºè¯„è®ºå†…å®¹
              let commentBody = `## ğŸ”’ Dependency Review\n\n`;
              commentBody += `âš ï¸ **æ£€æµ‹åˆ°å®‰å…¨æ¼æ´**\n\n`;
              commentBody += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
              
              // å¦‚æœæœ‰è¯¦ç»†çš„æ¼æ´ä¿¡æ¯ï¼Œæ˜¾ç¤ºç‰ˆæœ¬å‡çº§å»ºè®®
              if (vulnerabilities.length > 0) {
                commentBody += `### ğŸ“‹ æ¼æ´è¯¦æƒ…åŠä¿®å¤å»ºè®®\n\n`;
                
                // æŒ‰åŒ…åˆ†ç»„
                const vulnByPackage = {};
                vulnerabilities.forEach(vuln => {
                  const pkgName = vuln.package?.name || 'unknown';
                  const pkgVersion = vuln.package?.version || 'unknown';
                  const pkgKey = `${pkgName}@${pkgVersion}`;
                  
                  if (!vulnByPackage[pkgKey]) {
                    vulnByPackage[pkgKey] = {
                      name: pkgName,
                      version: pkgVersion,
                      ecosystem: vuln.package?.ecosystem || 'maven',
                      vulnerabilities: []
                    };
                  }
                  
                  vulnByPackage[pkgKey].vulnerabilities.push({
                    severity: vuln.severity || 'unknown',
                    ghsa_id: vuln.advisory?.ghsa_id,
                    cve_id: vuln.advisory?.cve_id,
                    summary: vuln.advisory?.summary,
                    patched_version: vuln.first_patched_version?.identifier || vuln.first_patched_version
                  });
                });
                
                // ç”Ÿæˆæ¼æ´åˆ—è¡¨ï¼Œæ˜¾ç¤ºå½“å‰ç‰ˆæœ¬å’Œç›®æ ‡ç‰ˆæœ¬
                Object.values(vulnByPackage).forEach((pkg, index) => {
                  const patchedVersions = [...new Set(pkg.vulnerabilities.map(v => v.patched_version).filter(Boolean))];
                  const targetVersion = patchedVersions.length > 0 ? patchedVersions[0] : 'å¾…ç¡®å®š';
                  
                  commentBody += `${index + 1}. **${pkg.name}**\n`;
                  commentBody += `   - ğŸ“¦ **å½“å‰ç‰ˆæœ¬**: \`${pkg.version}\`\n`;
                  commentBody += `   - âœ… **å»ºè®®å‡çº§è‡³**: \`${targetVersion}\`\n`;
                  
                  pkg.vulnerabilities.forEach((vuln, vulnIndex) => {
                    const severityEmoji = vuln.severity === 'critical' ? 'ğŸ”´' : vuln.severity === 'high' ? 'ğŸŸ ' : vuln.severity === 'moderate' ? 'ğŸŸ¡' : 'âšª';
                    commentBody += `   - ${severityEmoji} **${vuln.severity || 'unknown'}** severity`;
                    if (vuln.ghsa_id || vuln.cve_id) {
                      commentBody += ` (${vuln.ghsa_id || vuln.cve_id})`;
                    }
                    commentBody += `\n`;
                  });
                  commentBody += `\n`;
                });
              }
              
              commentBody += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Š</a>\n\n`;
              
              commentBody += `**æç¤º**: Dependabot ä¼šè‡ªåŠ¨åˆ›å»º PR æ¥ä¿®å¤å®‰å…¨æ¼æ´ã€‚å¦‚éœ€å¿½ç•¥è¿™æ¬¡æ£€æŸ¥ï¼Œè¯·åœ¨ PR ä¸Šæ·»åŠ  \`dependency-check-ignore\` æ ‡ç­¾ã€‚\n\n`;
              commentBody += `---\n`;
              commentBody += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;

              console.log('å‡†å¤‡åˆ›å»ºæ–°è¯„è®º...');
              console.log(`è¯„è®ºå†…å®¹é•¿åº¦: ${commentBody.length} å­—ç¬¦`);
              console.log(`Summary URL: ${summaryUrl}`);
              console.log(`è¯„è®ºå†…å®¹é¢„è§ˆ: ${commentBody.substring(0, 200)}...`);

              // æ¯æ¬¡éƒ½åˆ›å»ºæ–°è¯„è®ºï¼Œä¸æ›´æ–°ç°æœ‰è¯„è®º
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: commentBody
                });
                console.log('æ–°è¯„è®ºåˆ›å»ºæˆåŠŸ');
              } catch (createError) {
                console.error('åˆ›å»ºè¯„è®ºå¤±è´¥:', createError);
                throw createError;
              }

              // ç”±äºæ£€æµ‹åˆ°æ¼æ´ï¼Œè®¾ç½®è¾“å‡º
              core.setOutput('has-vulnerabilities', 'true');
              console.log('è„šæœ¬æ‰§è¡Œå®Œæˆ');
            } catch (error) {
              console.error('ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™:', error);
              console.error('é”™è¯¯å †æ ˆ:', error.stack);
              
              // æ„å»º Actions summary é¡µé¢é“¾æ¥
              const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              // è·å– PR è¯¦æƒ…
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt('${{ steps.get-pr-number.outputs.pr_number }}')
              });
              
              // å³ä½¿å‡ºé”™ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªåŒ…å« summary é“¾æ¥çš„è¯„è®ºï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰
              let errorComment = `## ğŸ”’ Dependency Review\n\nâš ï¸ **æ£€æµ‹åˆ°å®‰å…¨æ¼æ´**\n\n`;
              errorComment += `**Commit**: \`${pr.head.sha.substring(0, 7)}\`\n\n`;
              errorComment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">ğŸ“Š æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Šï¼ˆåŒ…å«ä¿®å¤ç‰ˆæœ¬å»ºè®®ï¼‰</a>\n\n`;
              errorComment += `**æ³¨æ„**: ç”Ÿæˆè¯„è®ºæ—¶é‡åˆ°é”™è¯¯: \`${error.message}\`\n\n`;
              errorComment += `**æç¤º**: è¯·æŸ¥çœ‹ Actions summary é¡µé¢è·å–è¯¦ç»†çš„æ¼æ´ä¿¡æ¯å’Œä¿®å¤ç‰ˆæœ¬å»ºè®®ã€‚\n\n`;
              errorComment += `---\n`;
              errorComment += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;
              
              try {
                // åˆ›å»ºæ–°è¯„è®ºï¼ˆä¸æ›´æ–°ç°æœ‰è¯„è®ºï¼‰
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt('${{ steps.get-pr-number.outputs.pr_number }}'),
                  body: errorComment
                });
                console.log('é”™è¯¯è¯„è®ºåˆ›å»ºæˆåŠŸ');
              } catch (commentError) {
                console.error('åˆ›å»ºé”™è¯¯è¯„è®ºæ—¶ä¹Ÿå¤±è´¥äº†:', commentError);
                // å¦‚æœè¿è¯„è®ºéƒ½åˆ›å»ºä¸äº†ï¼Œè‡³å°‘è¾“å‡ºåˆ°æ—¥å¿—
                core.setFailed(`æ— æ³•åˆ›å»ºè¯„è®º: ${commentError.message}`);
              }
              
              core.setOutput('has-vulnerabilities', 'true');
            }

      - name: Fail if vulnerabilities found
        if: steps.dep-review.outcome == 'failure'
        run: |
          echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹ PR è¯„è®ºä¸­çš„è¯¦ç»†æŠ¥å‘Š"
          exit 1
