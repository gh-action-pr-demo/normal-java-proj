name: Dependency Security Check

on:
  pull_request:
    # ä¸æŒ‡å®š branchesï¼Œè¡¨ç¤ºæ‰€æœ‰ PR éƒ½ä¼šè§¦å‘ï¼ˆä»»æ„ç›®æ ‡åˆ†æ”¯ï¼‰
  issue_comment:
    types: [created, edited]
  workflow_dispatch:

# ç¡®ä¿ workflow æœ‰æƒé™è¯»å–å’Œå†™å…¥
permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write

# åªåœ¨ PR ç›¸å…³çš„äº‹ä»¶æ—¶è¿è¡Œ
jobs:
  check-if-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    outputs:
      is-pr: ${{ steps.check.outputs.is-pr }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      should-trigger: ${{ steps.check.outputs.should-trigger }}
    steps:
      - name: Check if this is a PR and should trigger
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'pull_request') {
              core.setOutput('is-pr', 'true');
              core.setOutput('pr-number', context.issue.number);
              core.setOutput('should-trigger', 'true');
            } else if (context.eventName === 'issue_comment') {
              console.log('ğŸ“ æ£€æµ‹åˆ° issue_comment äº‹ä»¶');
              console.log(`è¯„è®ºå†…å®¹: ${context.payload.comment.body}`);
              console.log(`Issue ç¼–å·: ${context.issue.number}`);
              
              // æ£€æŸ¥æ˜¯å¦æ˜¯ PR çš„è¯„è®º
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number
              });
              
              console.log(`æ˜¯å¦ä¸º PR: ${!!issue.pull_request}`);
              
              if (issue.pull_request) {
                // è·å– PR ä¿¡æ¯ä»¥è·å– head SHA
                const { data: pr } = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number
                });
                
                console.log(`PR head SHA: ${pr.head.sha}`);
                
                // æ£€æŸ¥è¯„è®ºå†…å®¹æ˜¯å¦å®Œå…¨ç­‰äºï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰[skip-dependency-check]
                const commentBody = context.payload.comment.body.trim();
                const commentBodyLower = commentBody.toLowerCase();
                const skipKeyword = '[skip-dependency-check]';
                
                console.log(`è¯„è®ºå†…å®¹: ${commentBody}`);
                console.log(`è¯„è®ºå†…å®¹ï¼ˆå°å†™ï¼‰: ${commentBodyLower}`);
                console.log(`ç›®æ ‡å…³é”®å­—: ${skipKeyword}`);
                
                // åªæœ‰è¯„è®ºå†…å®¹å®Œå…¨ç­‰äºï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰[skip-dependency-check] æ—¶æ‰è§¦å‘
                const isExactMatch = commentBodyLower === skipKeyword.toLowerCase();
                console.log(`æ˜¯å¦å®Œå…¨åŒ¹é…: ${isExactMatch}`);
                
                if (isExactMatch) {
                  core.setOutput('is-pr', 'true');
                  core.setOutput('pr-number', context.issue.number);
                  core.setOutput('should-trigger', 'true');
                  core.setOutput('pr-head-sha', pr.head.sha);
                  console.log('âœ… è¯„è®ºå†…å®¹å®Œå…¨åŒ¹é… [skip-dependency-check]ï¼Œå°†è§¦å‘ workflow å¹¶è·³è¿‡æ£€æŸ¥');
                } else {
                  core.setOutput('is-pr', 'false');
                  core.setOutput('should-trigger', 'false');
                  console.log('â„¹ï¸ è¯„è®ºå†…å®¹ä¸åŒ¹é… [skip-dependency-check]ï¼Œä¸è§¦å‘ workflow');
                }
              } else {
                console.log('â„¹ï¸ è¿™ä¸æ˜¯ PR çš„è¯„è®ºï¼Œè·³è¿‡');
                core.setOutput('is-pr', 'false');
                core.setOutput('should-trigger', 'false');
              }
            } else {
              core.setOutput('is-pr', 'true'); // workflow_dispatch ä¹Ÿå…è®¸è¿è¡Œ
              core.setOutput('pr-number', '');
              core.setOutput('should-trigger', 'true');
            }

  dependency-check:
    needs: check-if-pr
    if: needs.check-if-pr.outputs.should-trigger == 'true'
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
      actions: read
      issues: write
      statuses: write

    steps:
      - name: Get PR head SHA for issue_comment event
        if: github.event_name == 'issue_comment'
        id: get-pr-sha
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('pr-head-sha', pr.head.sha);
            console.log(`PR head SHA: ${pr.head.sha}`);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•æ¥æ£€æŸ¥ PR è¯„è®º
          # å¯¹äº issue_comment äº‹ä»¶ï¼Œcheckout PR åˆ†æ”¯çš„ä»£ç 
          # å¯¹äº pull_request äº‹ä»¶ï¼Œcheckout PR åˆ†æ”¯çš„ä»£ç 
          # å¯¹äºå…¶ä»–äº‹ä»¶ï¼Œcheckout å½“å‰åˆ†æ”¯
          ref: ${{ github.event_name == 'issue_comment' && steps.get-pr-sha.outputs.pr-head-sha || github.event.pull_request.head.sha || github.sha }}
          # ç¡®ä¿èƒ½å¤Ÿè®¿é—® PR åˆ†æ”¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if skip file exists
        id: check-skip-file
        run: |
          if [ -f .github/dependency-check-skip ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°è·³è¿‡æ£€æŸ¥æ–‡ä»¶ (.github/dependency-check-skip)ï¼Œå°†è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR comments for skip keyword
        if: steps.check-skip-file.outputs.skip == 'false'
        id: check-skip-comment
        uses: actions/github-script@v7
        with:
          script: |
            const skipKeywords = [
              '[skip dependency check]',
              '[skip-dependency-check]',
              '[skip dependency-check]',
              '[skip-dependency check]'
            ];
            
            let hasSkipKeyword = false;
            
            if (context.eventName === 'issue_comment') {
              // å¯¹äº issue_comment äº‹ä»¶ï¼šåªæ£€æŸ¥è§¦å‘äº‹ä»¶çš„è¯„è®º
              // è¿™æ ·æ¯æ¬¡è¯„è®ºåªä¼šå½±å“å½“å‰è¿™æ¬¡è§¦å‘ï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºä¼šé‡æ–°æ£€æŸ¥
              const triggerComment = context.payload.comment.body.toLowerCase();
              hasSkipKeyword = skipKeywords.some(keyword => triggerComment.includes(keyword.toLowerCase()));
              
              if (hasSkipKeyword) {
                console.log('âœ… åœ¨è§¦å‘è¯„è®ºä¸­å‘ç°è·³è¿‡æ£€æŸ¥å…³é”®å­—ï¼Œå°†è·³è¿‡æœ¬æ¬¡ä¾èµ–å®‰å…¨æ£€æŸ¥');
                console.log('â„¹ï¸ æ³¨æ„ï¼šæ­¤è·³è¿‡ä»…å¯¹æœ¬æ¬¡è§¦å‘æœ‰æ•ˆï¼Œåç»­æ–°çš„ commit æˆ–è¯„è®ºå°†é‡æ–°æ‰§è¡Œæ£€æŸ¥');
              }
            } else if (context.eventName === 'pull_request') {
              // å¯¹äº pull_request äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              // å› ä¸ºè¿™æ˜¯æ–°çš„ commit è§¦å‘çš„ï¼Œåº”è¯¥æ­£å¸¸æ‰§è¡Œæ£€æŸ¥
              // å¦‚æœç”¨æˆ·æƒ³è·³è¿‡ï¼Œåº”è¯¥åœ¨ commit åæ·»åŠ è¯„è®ºæ¥è§¦å‘
              hasSkipKeyword = false;
              console.log('â„¹ï¸ pull_request äº‹ä»¶ï¼šæ­£å¸¸æ‰§è¡Œæ£€æŸ¥ï¼Œä¸æ£€æŸ¥ skip è¯„è®º');
            } else {
              // workflow_dispatch ç­‰å…¶ä»–äº‹ä»¶ï¼šä¸æ£€æŸ¥ skip è¯„è®º
              hasSkipKeyword = false;
            }
            
            if (hasSkipKeyword) {
              core.setOutput('skip', 'true');
            } else {
              core.setOutput('skip', 'false');
            }

      - name: Comment PR when skipped
        if: (steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true') && github.event_name != 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let prNumber = context.issue.number;
            
            let skipReason = '';
            if (fs.existsSync('.github/dependency-check-skip')) {
              skipReason = 'é…ç½®æ–‡ä»¶ (`.github/dependency-check-skip`)';
            } else {
              skipReason = 'PR è¯„è®ºä¸­çš„è·³è¿‡å…³é”®å­—';
            }
            
            const comment = `## â­ï¸ ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡\n\n` +
              `ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡ ${skipReason}ï¼‰ã€‚\n\n` +
              `âœ… çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶ã€‚\n\n` +
              `---\n\n` +
              `> ğŸ’¡ æç¤ºï¼šå¦‚æœåç»­æœ‰æ–°çš„ commitï¼Œå°†é‡æ–°æ‰§è¡Œä¾èµ–å®‰å…¨æ£€æŸ¥ã€‚`;
            
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip check if requested
        if: steps.check-skip-file.outputs.skip == 'true' || steps.check-skip-comment.outputs.skip == 'true'
        run: |
          echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆå·²é€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚è·³è¿‡ï¼‰"
          echo "âœ… æ£€æŸ¥å·²è·³è¿‡ï¼ŒçŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸ"
          exit 0

      - name: Set up JDK 17
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Check for dependency updates (direct dependencies only)
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: check-updates
        run: |
          echo "æ£€æŸ¥ç›´æ¥ä¾èµ–æ›´æ–°ï¼ˆä¸åŒ…æ‹¬ä¼ é€’ä¾èµ–ï¼‰..."
          mkdir -p target
          # åªæ£€æŸ¥ç›´æ¥ä¾èµ–çš„æ›´æ–°ï¼Œä¸æ£€æŸ¥ä¼ é€’ä¾èµ–
          # ä½¿ç”¨ -DexcludeReactor=false å’Œ -DprocessDependencyManagement=false æ¥åªæ£€æŸ¥ç›´æ¥ä¾èµ–
          mvn versions:display-dependency-updates -DprocessDependencies=true -DprocessDependencyManagement=false -DexcludeReactor=false -DoutputFile=target/dependency-updates.txt 2>&1 | tee target/dependency-updates-raw.txt || true
          
          if [ -f target/dependency-updates.txt ] && [ -s target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
            
            # ä½¿ç”¨å¤–éƒ¨ Python è„šæœ¬ç”Ÿæˆæ ¼å¼åŒ–çš„ Markdown æŠ¥å‘Š
            python3 scripts/parse-dependency-updates.py > target/dependency-updates.md || {
              echo "âš ï¸ Python è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹è¾“å‡º"
              echo "# ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ" > target/dependency-updates.md
              echo "" >> target/dependency-updates.md
              echo "### åŸå§‹è¾“å‡º" >> target/dependency-updates.md
              echo "" >> target/dependency-updates.md
              echo "\`\`\`" >> target/dependency-updates.md
              cat target/dependency-updates.txt >> target/dependency-updates.md
              echo "\`\`\`" >> target/dependency-updates.md
            }
            
            echo "âœ… å·²ç”Ÿæˆä¼˜åŒ–çš„ä¾èµ–æ›´æ–°æŠ¥å‘Šï¼štarget/dependency-updates.md"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ä¾èµ–æ›´æ–°ä¿¡æ¯æˆ–æ–‡ä»¶ä¸ºç©º"
          fi
        continue-on-error: true

      - name: Configure Maven settings (if private repo needed)
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        run: |
          # åˆ›å»º .m2 ç›®å½•
          mkdir -p ~/.m2
          
          # å¦‚æœå­˜åœ¨é¡¹ç›®çº§ Maven settings.xmlï¼Œä½¿ç”¨å®ƒ
          if [ -f .github/maven-settings.xml ]; then
            echo "âœ… ä½¿ç”¨é¡¹ç›®çº§ Maven settings.xml"
            cp .github/maven-settings.xml ~/.m2/settings.xml
          else
            echo "â„¹ï¸ æœªé…ç½®ç§æœï¼Œä½¿ç”¨é»˜è®¤ Maven ä¸­å¤®ä»“åº“"
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        if: steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        id: dependency-check
        env:
          # NVD API key æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸é…ç½®ä¼šä½¿ç”¨é»˜è®¤çš„é€Ÿç‡é™åˆ¶
          # å¦‚æœéœ€è¦æ›´é«˜çš„é€Ÿç‡é™åˆ¶ï¼Œå¯ä»¥ä» GitHub Secrets é…ç½®
          # NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          echo "æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰é…ç½® NVD API keyï¼Œå¯èƒ½ä¼šå—åˆ°é€Ÿç‡é™åˆ¶"
          echo "å¦‚æœéœ€è¦æ›´é«˜çš„é€Ÿç‡é™åˆ¶ï¼Œè¯·é…ç½® NVD_API_KEY secret"
          
          # è¿è¡Œä¾èµ–æ£€æŸ¥ï¼Œæ•è·é”™è¯¯ä½†ä¸ç«‹å³å¤±è´¥
          mvn verify -DskipTests -X 2>&1 | tee maven-output.log || {
            MAVEN_EXIT_CODE=$?
            echo "Maven å‘½ä»¤é€€å‡ºç : $MAVEN_EXIT_CODE"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼ˆè¿™æ˜¯é¢„æœŸçš„ï¼‰
            if grep -q "dependency-check-maven" maven-output.log && grep -q "One or more dependencies were identified with vulnerabilities" maven-output.log; then
              echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆï¼Œå‘ç°æ¼æ´ï¼ˆè¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºï¼‰"
              exit 0  # ä¾èµ–æ£€æŸ¥å‘ç°æ¼æ´ï¼Œä½†è¿™æ˜¯æ­£å¸¸çš„æ£€æŸ¥ç»“æœ
            elif grep -q "BUILD FAILURE" maven-output.log; then
              echo "âŒ Maven æ„å»ºå¤±è´¥"
              echo "=== Maven è¾“å‡ºï¼ˆæœ€å 100 è¡Œï¼‰==="
              tail -100 maven-output.log
              exit $MAVEN_EXIT_CODE
            else
              echo "âš ï¸ Maven æ‰§è¡Œå¼‚å¸¸"
              echo "=== Maven è¾“å‡ºï¼ˆæœ€å 100 è¡Œï¼‰==="
              tail -100 maven-output.log
              exit $MAVEN_EXIT_CODE
            fi
          }
          
          echo "âœ… Maven å‘½ä»¤æ‰§è¡Œå®Œæˆ"

      - name: List generated files
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          echo "=== dependency-check-reports ç›®å½• ==="
          if [ -d target/dependency-check-reports ]; then
            ls -lah target/dependency-check-reports/
            echo ""
            echo "æŠ¥å‘Šæ–‡ä»¶åˆ—è¡¨ï¼š"
            find target/dependency-check-reports -type f
          else
            echo "âŒ ç›®å½•ä¸å­˜åœ¨"
            echo "æ£€æŸ¥ Maven è¾“å‡ºæ—¥å¿—..."
            if [ -f maven-output.log ]; then
              echo "=== Maven è¾“å‡ºï¼ˆæœ€å 50 è¡Œï¼‰==="
              tail -50 maven-output.log
            fi
            echo ""
            echo "æ£€æŸ¥ target ç›®å½•ç»“æ„..."
            find target -type d -maxdepth 2 || echo "target ç›®å½•ä¸å­˜åœ¨"
          fi
          echo ""
          echo "=== target ç›®å½• ==="
          ls -lah target/ | grep -E "(dependency|update)" || echo "æœªæ‰¾åˆ°ç›¸å…³æ–‡ä»¶"

      - name: Upload dependency check reports
        if: always() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/dependency-check-report.html
            target/dependency-updates.txt
          retention-days: 30
          if-no-files-found: warn

      - name: Comment PR with detailed summary
        if: failure() && steps.check-skip-file.outputs.skip != 'true' && steps.check-skip-comment.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // è·å– PR ç¼–å·
            let prNumber = context.issue.number;
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
            } else if (context.eventName === 'pull_request') {
              prNumber = context.issue.number;
            }
            
            // è·å– Actions è¿è¡Œé“¾æ¥å’Œ Artifacts é“¾æ¥
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            const artifactsUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;
            
            // è·å– Artifacts ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆä¸‹è½½é“¾æ¥ï¼‰
            // æ³¨æ„ï¼šGitHub Artifacts éœ€è¦é€šè¿‡ Actions é¡µé¢ä¸‹è½½ï¼Œæ— æ³•ç›´æ¥ç”Ÿæˆä¸‹è½½é“¾æ¥
            // ä½†å¯ä»¥æä¾› Artifacts é¡µé¢çš„é“¾æ¥
            
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= 7.0ï¼‰ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n\n';
            comment += '- **çŠ¶æ€**: âŒ å¤±è´¥\n';
            comment += `- **Actions è¿è¡Œ**: [æŸ¥çœ‹è¯¦æƒ…](${runUrl})\n`;
            comment += `- **æŠ¥å‘Šä¸‹è½½**: [ä¸‹è½½ Artifactsï¼ˆåŒ…å« HTML æŠ¥å‘Šï¼‰](${artifactsUrl})\n`;
            comment += '  - åœ¨ Actions è¿è¡Œé¡µé¢åº•éƒ¨æ‰¾åˆ° "Artifacts" éƒ¨åˆ†\n';
            comment += '  - ç‚¹å‡» "dependency-check-reports" ä¸‹è½½æ‰€æœ‰æŠ¥å‘Š\n';
            comment += '  - HTML æŠ¥å‘Šï¼š`dependency-check-report.html`ï¼ˆæ¨èï¼Œå¯åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æŸ¥çœ‹ï¼‰\n';
            comment += '  - ä¾èµ–æ›´æ–°ï¼š`dependency-updates.txt`\n\n';
            comment += '---\n\n';
            
            // ç›´æ¥è¾“å‡º HTML æŠ¥å‘Šå†…å®¹ï¼ˆç”¨ä»£ç å—åŒ…è£¹ï¼‰
            try {
              const htmlReportPath = 'target/dependency-check-reports/dependency-check-report.html';
              if (fs.existsSync(htmlReportPath)) {
                const htmlContent = fs.readFileSync(htmlReportPath, 'utf8');
                
                comment += '### ğŸ“„ HTML æŠ¥å‘Šå†…å®¹\n\n';
                comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹ HTML æŠ¥å‘Šï¼ˆå»ºè®®ä¸‹è½½ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼‰</summary>\n\n';
                comment += '```html\n';
                
                // é™åˆ¶è¾“å‡ºé•¿åº¦ï¼Œé¿å…è¯„è®ºè¿‡é•¿ï¼ˆGitHub è¯„è®ºé™åˆ¶çº¦ä¸º 65536 å­—ç¬¦ï¼‰
                const maxChars = 50000;
                const displayContent = htmlContent.length > maxChars 
                  ? htmlContent.substring(0, maxChars) + `\n\n... (æŠ¥å‘Šè¿˜æœ‰ ${htmlContent.length - maxChars} ä¸ªå­—ç¬¦ï¼Œè¯·ä¸‹è½½å®Œæ•´ HTML æŠ¥å‘ŠæŸ¥çœ‹)`
                  : htmlContent;
                
                comment += displayContent;
                comment += '\n```\n';
                comment += '</details>\n\n';
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å– HTML æŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            // æ·»åŠ ä¿®å¤å»ºè®®
            comment += '### ğŸ’¡ ä¿®å¤å»ºè®®\n\n';
            comment += '1. **æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š**ï¼šä¸‹è½½ HTML æŠ¥å‘Šå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æŸ¥çœ‹å®Œæ•´ä¿¡æ¯\n';
            comment += '2. **æ›´æ–°ä¾èµ–ç‰ˆæœ¬**ï¼šä¼˜å…ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰\n';
            comment += '3. **æ·»åŠ æŠ‘åˆ¶è§„åˆ™**ï¼šå¦‚æœæ¼æ´å¯ä»¥æ¥å—ï¼Œåœ¨ `dependency-check-suppression.xml` ä¸­æ·»åŠ æŠ‘åˆ¶è§„åˆ™\n';
            comment += '4. **è·³è¿‡æ£€æŸ¥**ï¼šå¦‚æœæœ¬æ¬¡ PR ä¸æ¶‰åŠä¾èµ–å˜æ›´ï¼Œå¯ä»¥åœ¨ PR ä¸­æ·»åŠ è¯„è®º `[skip-dependency-check]` è·³è¿‡æ£€æŸ¥\n';
            comment += '5. **é‡æ–°æäº¤**ï¼šä¿®å¤åé‡æ–°æäº¤ PR\n\n';
            comment += '---\n\n';
            
            // æ·»åŠ ä¾èµ–æ›´æ–°ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            try {
              const updatesPath = 'target/dependency-updates.txt';
              if (fs.existsSync(updatesPath)) {
                const updatesContent = fs.readFileSync(updatesPath, 'utf8');
                if (updatesContent.trim()) {
                  comment += '### ğŸ“¦ ä¾èµ–æ›´æ–°æ£€æŸ¥ç»“æœ\n\n';
                  comment += '<details>\n<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹ä¾èµ–æ›´æ–°è¯¦æƒ…</summary>\n\n';
                  comment += '```\n';
                  
                  // é™åˆ¶è¾“å‡ºé•¿åº¦
                  const maxChars = 10000;
                  const displayContent = updatesContent.length > maxChars 
                    ? updatesContent.substring(0, maxChars) + `\n\n... (è¿˜æœ‰ ${updatesContent.length - maxChars} ä¸ªå­—ç¬¦ï¼Œè¯·ä¸‹è½½å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹)`
                    : updatesContent;
                  
                  comment += displayContent;
                  comment += '\n```\n';
                  comment += '</details>\n';
                }
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å–ä¾èµ–æ›´æ–°æ–‡ä»¶:', error.message);
            }
            
            // å‘é€è¯„è®º
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Report status check result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // æ£€æŸ¥æ˜¯å¦è·³è¿‡äº†æ£€æŸ¥
            const skipFile = process.env.SKIP_FILE === 'true';
            const skipComment = process.env.SKIP_COMMENT === 'true';
            const skipped = skipFile || skipComment;
            
            // è·å– PR ç¼–å·å’Œ SHA
            let prNumber = context.issue.number;
            let sha = context.sha;
            
            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
              // è·å– PR çš„ head SHA
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              sha = pr.head.sha;
            } else if (context.eventName === 'pull_request') {
              sha = context.payload.pull_request.head.sha;
            }
            
            if (skipped) {
              // è·³è¿‡æ£€æŸ¥æ—¶ï¼ŒæŠ¥å‘ŠæˆåŠŸçŠ¶æ€
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: sha,
                state: 'success',
                context: 'Dependency Security Check / OWASP Dependency Check',
                description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥å·²è·³è¿‡ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰',
                target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
              console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰');
            } else {
              // æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
              const checkOutcome = process.env.CHECK_OUTCOME || 'unknown';
              
              if (checkOutcome === 'failure') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'failure',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âŒ çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºå¤±è´¥');
              } else if (checkOutcome === 'success') {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: sha,
                  state: 'success',
                  context: 'Dependency Security Check / OWASP Dependency Check',
                  description: 'ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡',
                  target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log('âœ… çŠ¶æ€æ£€æŸ¥å·²æŠ¥å‘Šä¸ºæˆåŠŸ');
              }
            }

      - name: Check scan result
        if: always()
        env:
          SKIP_FILE: ${{ steps.check-skip-file.outputs.skip }}
          SKIP_COMMENT: ${{ steps.check-skip-comment.outputs.skip }}
          CHECK_OUTCOME: ${{ steps.dependency-check.outcome }}
        run: |
          # å¦‚æœè·³è¿‡äº†æ£€æŸ¥ï¼Œç›´æ¥æˆåŠŸé€€å‡º
          if [ "$SKIP_FILE" == "true" ] || [ "$SKIP_COMMENT" == "true" ]; then
            echo "âœ… å·²è·³è¿‡ä¾èµ–å®‰å…¨æ£€æŸ¥ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶æˆ– PR è¯„è®ºè¯·æ±‚ï¼‰"
            echo "çŠ¶æ€æ£€æŸ¥å°†æ ‡è®°ä¸ºæˆåŠŸï¼ŒPR å¯ä»¥åˆå¹¶"
            exit 0
          fi
          
          # æ£€æŸ¥å®é™…çš„æ£€æŸ¥ç»“æœ
          if [ "$CHECK_OUTCOME" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤ï¼Œæˆ–åœ¨ PR ä¸­æ·»åŠ è¯„è®º [skip-dependency-check] è·³è¿‡æ£€æŸ¥"
            exit 1
          elif [ "$CHECK_OUTCOME" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
            exit 0
          elif [ "$CHECK_OUTCOME" == "skipped" ]; then
            echo "âš ï¸ ä¾èµ–æ£€æŸ¥æ­¥éª¤è¢«è·³è¿‡"
            exit 0
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€æœªçŸ¥: $CHECK_OUTCOME"
            exit 1
          fi
