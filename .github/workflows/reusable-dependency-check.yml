name: Reusable Dependency Check Workflow

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        default: '17'
        type: string
      fail-on-cvss:
        description: 'CVSS score threshold to fail build'
        required: false
        default: '7.0'
        type: string
      org-suppression-url:
        description: 'URL to organization-level suppression file'
        required: false
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}
          cache: 'maven'

      - name: Download organization suppression file
        if: inputs.org-suppression-url != ''
        run: |
          echo "ä¸‹è½½ç»„ç»‡çº§æŠ‘åˆ¶è§„åˆ™æ–‡ä»¶..."
          mkdir -p .github/configs
          curl -L -o .github/configs/org-suppression.xml "${{ inputs.org-suppression-url }}" || echo "æ— æ³•ä¸‹è½½ç»„ç»‡çº§é…ç½®æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é¡¹ç›®çº§é…ç½®"
        continue-on-error: true

      - name: Update pom.xml with organization suppression file
        if: inputs.org-suppression-url != '' && hashFiles('.github/configs/org-suppression.xml') != ''
        run: |
          echo "æ›´æ–° pom.xml ä»¥åŒ…å«ç»„ç»‡çº§æŠ‘åˆ¶è§„åˆ™..."
          # è¿™é‡Œå¯ä»¥ä½¿ç”¨ sed æˆ–å…¶ä»–å·¥å…·æ›´æ–° pom.xmlï¼Œæ·»åŠ ç»„ç»‡çº§æŠ‘åˆ¶æ–‡ä»¶
          # æˆ–è€…é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’é…ç½®
        continue-on-error: true

      - name: Check for dependency updates
        id: check-updates
        run: |
          echo "æ£€æŸ¥ä¾èµ–æ›´æ–°..."
          mvn versions:display-dependency-updates -DoutputFile=target/dependency-updates.txt || true
          if [ -f target/dependency-updates.txt ]; then
            echo "ä¾èµ–æ›´æ–°ä¿¡æ¯å·²ä¿å­˜åˆ° target/dependency-updates.txt"
          fi
        continue-on-error: true

      - name: Run OWASP Dependency-Check
        id: dependency-check
        env:
          FAIL_ON_CVSS: ${{ inputs.fail-on-cvss }}
        run: |
          echo "è¿è¡Œ OWASP Dependency-Check å®‰å…¨æ‰«æ..."
          echo "CVSS é˜ˆå€¼: $FAIL_ON_CVSS"
          # å¦‚æœ pom.xml ä¸­é…ç½®äº† failBuildOnCVSSï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡å±æ€§è¦†ç›–
          mvn verify -DskipTests -Ddependency-check.failBuildOnCVSS=$FAIL_ON_CVSS

      - name: Upload dependency check reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-reports
          path: |
            target/dependency-check-reports/*.html
            target/dependency-check-reports/*.json
            target/dependency-updates.txt
          retention-days: 30

      - name: Comment PR with summary
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ğŸ”’ ä¾èµ–å®‰å…¨æ£€æŸ¥å¤±è´¥\n\n';
            comment += 'æ£€æµ‹åˆ°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ˆCVSS >= ${{ inputs.fail-on-cvss }}ï¼‰ã€‚\n\n';
            comment += 'è¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤æ¼æ´åå†æäº¤ã€‚\n\n';
            comment += '### ğŸ“‹ æ£€æŸ¥ç»“æœ\n';
            comment += '- çŠ¶æ€: âŒ å¤±è´¥\n';
            comment += '- CVSS é˜ˆå€¼: ${{ inputs.fail-on-cvss }}\n';
            comment += '- æŠ¥å‘Š: è¯·ä¸‹è½½ Artifacts ä¸­çš„ dependency-check-reports æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯\n\n';
            
            // å°è¯•è¯»å– JSON æŠ¥å‘Šå¹¶æå–å…³é”®ä¿¡æ¯
            try {
              const reportPath = 'target/dependency-check-reports/dependency-check-report.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                if (report.dependencies) {
                  const vulnerabilities = report.dependencies
                    .filter(dep => dep.vulnerabilities && dep.vulnerabilities.length > 0)
                    .flatMap(dep => dep.vulnerabilities.map(vuln => ({
                      name: dep.packages[0]?.name || 'Unknown',
                      cve: vuln.name,
                      severity: vuln.severity || 'Unknown',
                      cvssv3: vuln.cvssv3?.baseScore || vuln.cvssv2?.score || 'N/A'
                    })));
                  
                  if (vulnerabilities.length > 0) {
                    comment += '### ğŸš¨ å‘ç°çš„é«˜é£é™©æ¼æ´\n\n';
                    comment += '| ä¾èµ– | CVE | ä¸¥é‡ç¨‹åº¦ | CVSS åˆ†æ•° |\n';
                    comment += '|------|-----|----------|----------|\n';
                    vulnerabilities.slice(0, 10).forEach(v => {
                      comment += `| ${v.name} | ${v.cve} | ${v.severity} | ${v.cvssv3} |\n`;
                    });
                    if (vulnerabilities.length > 10) {
                      comment += `\n*è¿˜æœ‰ ${vulnerabilities.length - 10} ä¸ªæ¼æ´ï¼Œè¯·æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š*\n`;
                    }
                  }
                }
              }
            } catch (error) {
              console.log('æ— æ³•è§£ææŠ¥å‘Šæ–‡ä»¶:', error.message);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Check scan result
        if: always()
        run: |
          if [ "${{ steps.dependency-check.outcome }}" == "failure" ]; then
            echo "âŒ å‘ç°é«˜é£é™©ä¾èµ–æ¼æ´ï¼ŒPR æ— æ³•åˆå¹¶"
            echo "è¯·ä¿®å¤æ¼æ´åé‡æ–°æäº¤"
            exit 1
          elif [ "${{ steps.dependency-check.outcome }}" == "success" ]; then
            echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸ æ£€æŸ¥çŠ¶æ€: ${{ steps.dependency-check.outcome }}"
            exit 1
          fi

