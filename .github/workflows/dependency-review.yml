name: Dependency Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Check skip keywords in PR comments
        id: skipchk
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            const patterns = [
              /\[skip dependency check\]/i,
              /\[skip-dependency-check\]/i,
              /\[skip dependency-check\]/i,
              /\[skip-dependency check\]/i
            ];
            const hasSkip = comments.some(c => patterns.some(p => p.test(c.body || '')));
            core.setOutput('skip', String(hasSkip));

      - name: Skip notice
        if: steps.skipchk.outputs.skip == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: "✅ 已根据评论关键字跳过依赖变更审查（Dependency Review）。"
            });

      - name: Early exit after skip
        if: steps.skipchk.outputs.skip == 'true'
        run: echo "Skipped by keyword." && exit 0

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: true

      - name: Post filtered summary comment
        if: startsWith(github.event_name, 'pull_request')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '.github/ignore-deps.txt';
            let ignored = [];
            if (fs.existsSync(path)) {
              ignored = fs.readFileSync(path, 'utf8')
                .split('\n')
                .map(s => s.trim())
                .filter(s => s && !s.startsWith('#'));
            }
            const header = 'Dependency Review（过滤后摘要）';
            const bodyLines = [];
            if (ignored.length) {
              bodyLines.push('已忽略的依赖（按规则文件）：');
              for (const item of ignored) bodyLines.push(`- ${item}`);
              bodyLines.push('');
            } else {
              bodyLines.push('无忽略规则。');
              bodyLines.push('');
            }
            bodyLines.push('完整明细请查看本次 Actions 运行页面的 Dependency Review 日志。');
            const body = `### ${header}\n\n` + bodyLines.join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number("${{ steps.ctx.outputs.prNumber }}"),
              body
            });


