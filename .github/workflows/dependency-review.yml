name: Dependency Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dependency Review
        id: dep-review
        continue-on-error: true
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

      - name: Get dependency review results and post comment
        id: get-results
        if: steps.dep-review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              console.log('æ£€æµ‹åˆ°æ¼æ´ï¼Œå¼€å§‹ç”ŸæˆæŠ¥å‘Š...');
              console.log(`Head SHA: ${context.payload.pull_request.head.sha}`);
              console.log(`Run ID: ${context.runId}`);
              
              // æ„å»º Actions summary é¡µé¢é“¾æ¥
              const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              // å°è¯•è·å– Dependabot alerts ä»¥è·å–ä¿®å¤ç‰ˆæœ¬ä¿¡æ¯
              let vulnerabilitiesInfo = '';
              try {
                console.log('å°è¯•è·å– Dependabot alerts...');
                const { data: alerts } = await github.rest.dependabot.listAlertsForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
                
                console.log(`è·å–åˆ° ${alerts.length} ä¸ª Dependabot alerts`);
                
                if (alerts.length > 0) {
                  vulnerabilitiesInfo = `\n### æ¼æ´è¯¦æƒ…åŠä¿®å¤å»ºè®®\n\n`;
                  
                  // æŒ‰åŒ…åˆ†ç»„
                  const vulnByPackage = {};
                  alerts.forEach(alert => {
                    const pkgName = alert.dependency?.package?.name || 'unknown';
                    const pkgVersion = alert.dependency?.version || 'unknown';
                    const pkgKey = `${pkgName}@${pkgVersion}`;
                    
                    if (!vulnByPackage[pkgKey]) {
                      vulnByPackage[pkgKey] = {
                        name: pkgName,
                        version: pkgVersion,
                        ecosystem: alert.dependency?.package?.ecosystem || 'maven',
                        vulnerabilities: []
                      };
                    }
                    
                    vulnByPackage[pkgKey].vulnerabilities.push({
                      severity: alert.security_vulnerability?.severity || 'unknown',
                      ghsa_id: alert.security_advisory?.ghsa_id,
                      cve_id: alert.security_advisory?.cve_id,
                      summary: alert.security_advisory?.summary,
                      cvss_score: alert.security_vulnerability?.cvss?.score,
                      patched_version: alert.security_vulnerability?.first_patched_version?.identifier
                    });
                  });
                  
                  // ç”Ÿæˆæ¼æ´åˆ—è¡¨
                  Object.values(vulnByPackage).forEach((pkg, index) => {
                    vulnerabilitiesInfo += `${index + 1}. **${pkg.name}@${pkg.version}**\n`;
                    
                    pkg.vulnerabilities.forEach((vuln, vulnIndex) => {
                      const severityEmoji = vuln.severity === 'critical' ? 'ğŸ”´' : vuln.severity === 'high' ? 'ğŸŸ ' : vuln.severity === 'moderate' ? 'ğŸŸ¡' : 'âšª';
                      vulnerabilitiesInfo += `   ${vulnIndex + 1}. ${severityEmoji} **${vuln.severity || 'unknown'}** severity\n`;
                      
                      if (vuln.ghsa_id || vuln.cve_id) {
                        vulnerabilitiesInfo += `      - **Advisory**: ${vuln.ghsa_id || vuln.cve_id}\n`;
                      }
                      
                      if (vuln.patched_version) {
                        vulnerabilitiesInfo += `      - **å»ºè®®å‡çº§è‡³**: \`${vuln.patched_version}\`\n`;
                      } else {
                        vulnerabilitiesInfo += `      - **ä¿®å¤ç‰ˆæœ¬**: æš‚æ— å¯ç”¨ä¿®å¤ç‰ˆæœ¬\n`;
                      }
                      
                      vulnerabilitiesInfo += `\n`;
                    });
                  });
                }
              } catch (alertsError) {
                console.log('æ— æ³•è·å– Dependabot alerts:', alertsError.message);
                // å¦‚æœæ— æ³•è·å–ï¼Œç»§ç»­ä½¿ç”¨ summary é“¾æ¥
              }
              
              // åˆ›å»ºè¯„è®ºå†…å®¹ï¼ŒåŒ…å«æŒ‡å‘ Actions summary çš„é“¾æ¥ï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰
              let commentBody = `## Dependency Review\n\n`;
              commentBody += `âš ï¸ **æ£€æµ‹åˆ°å®‰å…¨æ¼æ´**\n\n`;
              commentBody += `**Commit**: \`${context.payload.pull_request.head.sha.substring(0, 7)}\`\n\n`;
              
              // å¦‚æœæœ‰æ¼æ´è¯¦æƒ…ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
              if (vulnerabilitiesInfo) {
                commentBody += vulnerabilitiesInfo;
                commentBody += `\n`;
              }
              
              commentBody += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Š</a>\n\n`;
              
              if (!vulnerabilitiesInfo) {
                commentBody += `**æç¤º**: Dependabot ä¼šè‡ªåŠ¨åˆ›å»º PR æ¥ä¿®å¤å®‰å…¨æ¼æ´ã€‚ä½ å¯ä»¥åœ¨æŠ¥å‘Šé¡µé¢æŸ¥çœ‹æ¯ä¸ªæ¼æ´å»ºè®®å‡çº§åˆ°çš„ç‰ˆæœ¬ã€‚\n\n`;
              }
              
              commentBody += `---\n`;
              commentBody += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;

              console.log('å‡†å¤‡åˆ›å»ºæ–°è¯„è®º...');
              console.log(`è¯„è®ºå†…å®¹é•¿åº¦: ${commentBody.length} å­—ç¬¦`);
              console.log(`Summary URL: ${summaryUrl}`);
              console.log(`è¯„è®ºå†…å®¹é¢„è§ˆ: ${commentBody.substring(0, 200)}...`);

              // æ¯æ¬¡éƒ½åˆ›å»ºæ–°è¯„è®ºï¼Œä¸æ›´æ–°ç°æœ‰è¯„è®º
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: commentBody
                });
                console.log('æ–°è¯„è®ºåˆ›å»ºæˆåŠŸ');
              } catch (createError) {
                console.error('åˆ›å»ºè¯„è®ºå¤±è´¥:', createError);
                throw createError;
              }

              // ç”±äºæ£€æµ‹åˆ°æ¼æ´ï¼Œè®¾ç½®è¾“å‡º
              core.setOutput('has-vulnerabilities', 'true');
              console.log('è„šæœ¬æ‰§è¡Œå®Œæˆ');
            } catch (error) {
              console.error('ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™:', error);
              console.error('é”™è¯¯å †æ ˆ:', error.stack);
              
              // æ„å»º Actions summary é¡µé¢é“¾æ¥
              const summaryUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
              
              // å³ä½¿å‡ºé”™ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ªåŒ…å« summary é“¾æ¥çš„è¯„è®ºï¼ˆåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰
              let errorComment = `## Dependency Review\n\nâš ï¸ **æ£€æµ‹åˆ°å®‰å…¨æ¼æ´**\n\n`;
              errorComment += `**Commit**: \`${context.payload.pull_request.head.sha.substring(0, 7)}\`\n\n`;
              errorComment += `<a href="${summaryUrl}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å®Œæ•´çš„ä¾èµ–å®‰å…¨æ£€æŸ¥æŠ¥å‘Šï¼ˆåŒ…å«ä¿®å¤ç‰ˆæœ¬å»ºè®®ï¼‰</a>\n\n`;
              errorComment += `**æç¤º**: Dependabot ä¼šè‡ªåŠ¨åˆ›å»º PR æ¥ä¿®å¤å®‰å…¨æ¼æ´ã€‚ä½ å¯ä»¥åœ¨æŠ¥å‘Šé¡µé¢æŸ¥çœ‹æ¯ä¸ªæ¼æ´å»ºè®®å‡çº§åˆ°çš„ç‰ˆæœ¬ã€‚\n\n`;
              errorComment += `**æ³¨æ„**: ç”Ÿæˆè¯„è®ºæ—¶é‡åˆ°é”™è¯¯: \`${error.message}\`\n\n`;
              errorComment += `---\n`;
              errorComment += `*æ­¤è¯„è®ºç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*\n`;
              
              try {
                // åˆ›å»ºæ–°è¯„è®ºï¼ˆä¸æ›´æ–°ç°æœ‰è¯„è®ºï¼‰
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: errorComment
                });
                console.log('é”™è¯¯è¯„è®ºåˆ›å»ºæˆåŠŸ');
              } catch (commentError) {
                console.error('åˆ›å»ºé”™è¯¯è¯„è®ºæ—¶ä¹Ÿå¤±è´¥äº†:', commentError);
                // å¦‚æœè¿è¯„è®ºéƒ½åˆ›å»ºä¸äº†ï¼Œè‡³å°‘è¾“å‡ºåˆ°æ—¥å¿—
                core.setFailed(`æ— æ³•åˆ›å»ºè¯„è®º: ${commentError.message}`);
              }
              
              core.setOutput('has-vulnerabilities', 'true');
            }

      - name: Fail if vulnerabilities found
        if: steps.dep-review.outcome == 'failure'
        run: |
          echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æŸ¥çœ‹ PR è¯„è®ºä¸­çš„è¯¦ç»†æŠ¥å‘Š"
          exit 1
